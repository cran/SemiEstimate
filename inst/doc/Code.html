<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>SemiEstimate Examples</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">SemiEstimate Examples</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(SemiEstimate)</a></code></pre></div>
<div id="introduction-to-implicit-profiling" class="section level1">
<h1>Introduction to Implicit Profiling</h1>
<div id="preliminaries" class="section level2">
<h2>Preliminaries</h2>
<p>Assume we have a convex objective function <span class="math inline">\(\mathcal{L}(\theta, \lambda)\)</span>, where <span class="math inline">\(\theta\)</span> is the parametric component with fixed dimension and <span class="math inline">\(\lambda\)</span> is the parameter for finite-dimensional approximation of nonparametric component whose dimension may grow with the sample size. Further assume <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span> are bundled in this objective function, i.e., <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span> cannot be clearly separated. Typical examples of this case include the semiparametric transformation model and the semiparametric GARCH-in-mean model, which are discussed in details in Section 4 and 5. It is worth noting that, <span class="math inline">\(\lambda\)</span> can also be a smooth function with infinite dimension. Then one can apply semiparametric methods to estimate <span class="math inline">\(\lambda\)</span>.</p>
<p>To estimate <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span>, let <span class="math inline">\(\Psi(\theta, \lambda)\)</span> and <span class="math inline">\(\Phi(\theta, \lambda)\)</span> denote the estimation equations with respect <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span>, respectively. Specifically, <span class="math inline">\(\Psi(\theta, \lambda)\)</span> is the derivative of <span class="math inline">\(\mathcal{L}(\theta, \lambda)\)</span> with respect to <span class="math inline">\(\theta\)</span>. When <span class="math inline">\(\lambda\)</span> is the nuisance parameter, then <span class="math inline">\(\Phi(\theta, \lambda)\)</span> is the derivative of <span class="math inline">\(\mathcal{L}(\theta, \lambda)\)</span> with respect to <span class="math inline">\(\lambda\)</span> . In the case that <span class="math inline">\(\lambda\)</span> is the smooth function, then <span class="math inline">\(\Phi(\theta, \lambda)\)</span> denotes the semiparametric estimation formula, such as the kernel smooth method or spline function. Then, to estimate <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span>, we need to solve: <span class="math display">\[\Psi(\theta,\lambda) = \mathbf{0}\]</span> <span class="math display">\[\Phi(\theta, \lambda) = \mathbf{0}.\nonumber\]</span></p>
<p> Let <span class="math inline">\(\mathbf{G}(\theta, \lambda) = (\Psi(\theta, \lambda)^{\top}, \Phi(\theta, \lambda)^{\top})^{\top}\)</span>. The entire updating algorithm (e.g, the Newton-Raphson method) requires <span class="math inline">\(\mathbf{G}(\theta, \lambda)=\mathbf{0}\)</span>. Let <span class="math inline">\(\beta = (\theta^{\top}, \lambda^{\top})^{\top}\)</span>. Then the updating formula is $^{(k+1)} = ^{(k)} - ((<sup>{(k)})/)</sup>{-1}(^{(k)}) $. However, due to the bundled relationship of <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span>, the two parameters are often difficult to separate. This would result in a dense Hessian matrix <span class="math inline">\(\partial \mathbf{G}/\partial \beta\)</span>. Consequently, the calculation of the inverse of the Hessian matrix often suffers from high computational cost, which makes the entire updating algorithm computationally very inefficient.</p>
<p>To solve this prolambdaem, many recursive updating methods have been applied . Basically, the recursive method breaks the connection of <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span> in the Hessian matrix. In other words, it considers the second-order derivative of the objective function with respect to each parameter, separately. Specifically, the updating formulas for the recursive method is given below: <span class="math display">\[\lambda^{(k+1)} = \lambda^{(k)} - \left(\frac{\partial \Phi(\theta^{(k)}, \lambda^{(k)})}{ \partial \lambda}\right)^{-1}\Phi(\theta^{(k)}, \lambda^{(k)})\]</span> <span class="math display">\[\theta^{(k+1)} = \theta^{(k)} - \left(\frac{\partial \Psi(\theta^{(k)}, \lambda^{(k+1)})}{ \partial \theta}\right)^{-1}\Psi(\theta^{(k)}, \lambda^{(k+1)}).\]</span></p>
<p>Although the update for <span class="math inline">\(\lambda\)</span> is still a sub-prolambdaem with growing dimension, the sub-prolambdaem Hessian <span class="math inline">\(\partial \Phi/\partial \lambda\)</span> is often sparse by the design of the finite dimensional approximation of the nonparametric component — different element in <span class="math inline">\(\lambda\)</span> usually corresponds to the value of the nonparametric component at different locations. Consequently, inverting <span class="math inline">\(\partial \Phi/\partial \lambda\)</span> can be much faster than inverting <span class="math inline">\(\partial \mathbf{G}/\partial \beta\)</span>. The updating formula in  iterates each parameter without considering the interaction with the other parameter. In other words, it makes approximation to the true second-order derivative <span class="math inline">\(\partial \mathbf{G}/\partial \beta\)</span> by setting the off-diagonal lambdaocks zero. For example, when updating <span class="math inline">\(\theta\)</span>, the derivative <span class="math inline">\(\partial \Psi/\partial \theta\)</span> considers <span class="math inline">\(\lambda\)</span> as a constant and does not take into account the current value of <span class="math inline">\(\lambda\)</span>. Under the situation that <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span> are strongly correlated with each other, the recursive method would definitely loss information and thus result in sub-optimal update directions.</p>
</div>
<div id="implicit-profiling-algorithm" class="section level2">
<h2>Implicit Profiling Algorithm</h2>
<p>Both the entire updating method and recursive method are computationally inefficient. To address this issue, we propose an implicit profiling method. It is notalambdae that, <span class="math inline">\(\theta\)</span> is the only parameter of interest. Therefore, we only focus on the efficient estimation of <span class="math inline">\(\theta\)</span>. Recall that, in the recursive method, the updating formula for <span class="math inline">\(\theta\)</span> has lost some information by treating <span class="math inline">\(\lambda\)</span> as a constant, which makes the estimation of <span class="math inline">\(\theta\)</span> inefficient. To address this prolambdaem, we propose an implicit profiling (IP) method. Specifically, we regard <span class="math inline">\(\lambda\)</span> as the function of <span class="math inline">\(\theta\)</span>, which we denote by <span class="math inline">\(\lambda(\theta)\)</span>. Then, the second-order derivative of the objective function respect to <span class="math inline">\(\theta\)</span> can be derived as follows:</p>
<p><span class="math display">\[\frac{\partial \Psi(\theta, \lambda(\theta))}{\partial \theta} = \frac{\partial \Psi(\theta, \lambda(\theta))}{\partial \theta} + \frac{\partial \Psi(\theta, \lambda(\theta))}{\partial\lambda(\theta)}\frac{\partial\lambda(\theta)}{\partial\theta}\]</span></p>
<p>where the derivative relationship <span class="math inline">\(\partial\lambda/\partial\theta\)</span> can be othetaained by solving <span class="math inline">\(\partial \Phi(\theta, \lambda(\theta))/\partial\lambda = \mathbf{0}\)</span>. We refer to  as the implicit profiling Hessian matrix of <span class="math inline">\(\theta\)</span>, which decides the updating direction of <span class="math inline">\(\theta\)</span> in the implicit profiling method. Based on , we can update <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span> iteratively using the following updating formulas:</p>
<p><span class="math display">\[\lambda^{(k+1)} = \lambda^{(k)} - \left(\frac{\partial \Phi(\theta^{(k)}, \lambda^{(k)})}{\partial \lambda}\right)^{-1}\Phi(\theta^{(k)}, \lambda^{(k)})\]</span> <span class="math display">\[\theta^{(k+1)} = \theta^{(k)} -\left( \frac{\partial \Psi(\theta^{(k)}, \lambda^{(k+1)})}{\partial \theta} + \frac{\partial \Psi(\theta^{(k)}, \lambda^{(k+1)})}{\partial \lambda}\frac{\partial\lambda^{(k+1)}}{\partial\theta}\right)^{-1}\Psi(\theta^{(k)}, \lambda^{(k+1)})\]</span></p>
<p>The complete algorithm of the implicit profiling method is present in Algorithm .</p>
<p><strong>The Implicit Profiling Algorithm</strong></p>
<ol style="list-style-type: decimal">
<li>Initialize <span class="math inline">\(\theta^{(0)}\)</span>;</li>
<li>Solve <span class="math inline">\(\lambda^{(0)}\)</span> from the equation <span class="math inline">\(\Phi(\theta^{(0)}, \lambda^{(0)}) = \mathbf{0}\)</span>;</li>
<li>REPEAT UNTIL Convergence</li>
</ol>
<ul>
<li>Update <span class="math inline">\(\lambda\)</span> from <span class="math display">\[\lambda^{(k+1)} = \lambda^{(k)} - \left(\frac{\partial \Phi(\theta^{(k)}, \lambda^{(k)})}{\partial \lambda}\right)^{-1}\Phi(\theta^{(k)}, \lambda^{(k)});\nonumber\]</span></li>
<li>Solve the implicit gradient <span class="math inline">\(\mathbf{d}^{(k+1)} = \partial\lambda^{(k+1)}(\theta^{(k)})/\partial\theta\)</span> from <span class="math display">\[\frac{d\Phi(\theta^{(k)},\lambda^{(k+1)})}{d\theta} = \frac{\partial\Phi(\theta^{(k)}, \lambda^{(k+1)})}{\partial \theta} + \frac{\partial \Phi(\theta^{(k)}, \lambda^{(k+1)})}{\partial\lambda}\mathbf{d}^{(k+1)} = \mathbf{0}\nonumber\]</span></li>
<li>Compute the implicit profiling Hessian: <span class="math display">\[\mathbb{H}^{(k+1)}  =   \frac{\partial \Psi(\theta^{(k)}, \lambda^{(k+1)})}{\partial \theta} + \frac{\partial \Psi(\theta^{(k)}, \lambda^{(k+1)})}{\partial \lambda}\mathbf{d}^{(k+1)}.\]</span></li>
<li>Update <span class="math inline">\(\theta\)</span> from <span class="math display">\[\theta^{(k+1)} = \theta^{(k)} - \mathbb{H}^{-1}\Psi(\theta^{(k)}, \lambda^{(k+1)});\nonumber\]</span></li>
</ul>
<p>For the initialization of <span class="math inline">\(\lambda\)</span>, it is recommended to solve the equation <span class="math inline">\(\Phi(\theta^{(0)}, \lambda^{(0)}) = \mathbf{0}\)</span>, which can help to improve the convergence speed. However, this calculation may also require high computational cost. In the case that the computational cost is not acceptalambdae, one can also randomly choose an initial value. In each updating iteration, we first update <span class="math inline">\(\lambda\)</span>, which is denoted by <span class="math inline">\(\lambda^{(k+1)}\)</span>. Then, we calculate the implicit profiling Hessian matrix of <span class="math inline">\(\theta\)</span> using the newly updated <span class="math inline">\(\lambda^{(k+1)}\)</span>, and then get an updated value <span class="math inline">\(\theta^{(k+1)}\)</span>. Repeat the iteration steps until convergence, which leads to the final estimates of <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span>.</p>
<p>It is notalambdae that, the implicit profiling method accounts for the interaction between <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\lambda\)</span> by treating <span class="math inline">\(\lambda\)</span> as a function of <span class="math inline">\(\theta\)</span>. Consequently, the resulting estimator of <span class="math inline">\(\theta\)</span> should be equal to the estimate implemented by the entire updating method. We summarize this finding in the following two propositions.</p>
<p>Assume the objective function <span class="math inline">\(\mathcal{L}\)</span> is strictly convex. Convergent point of implicit profiling method and that of Newton-Raphson method are identical.</p>
<p>For any local quadratic prolambdaem <span class="math inline">\(Q\)</span>, implicit profiling method reaches its minimal within two steps.</p>
<p>The detailed proof of the two propositions are given in Appendix A.1 and A.2, respectively. Propositions 1 and 2 estalambdaished that the implicit profiling method shared the theoretical properties of the Newton-Raphson method. By Proposition 1, implicit profiling only converges at the minimum of the convex loss. By Proposition 2, the convergence is guaranteed when the Newton-Raphson method converges, and the number of iterations taken before converges is comparalambdae to that of the Newton-Raphson method. Later in the experiments, we found that the fewer number of iterations is the driving factor for implicit profiling method’s advantage in run time compared to other iterative methods. In many cases, single iteration of the implicit profiling can be faster than that of the Newton-Raphson method when the dependence structure of <span class="math inline">\(\theta\)</span>, <span class="math inline">\(\lambda\)</span> and the loss function enalambdaes the implicit profiling to simplify the whole Hessian matrix calculation and global value searching of the Newton-Raphson method. Together with the control on the number of iterations, the implicit profiling method is computationally more efficient than the Newton-Raphson method.</p>
</div>
</div>
<div id="toy-example" class="section level1">
<h1>toy example</h1>
<p>The average number of iterative steps consumed by the Newton-Raphson method, the naive iteration method and the implicit proling method.</p>
<div id="code" class="section level2">
<h2>Code</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># =====================================</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># ======= z = x^2 + y^2 + alpha xy=====</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co"># =====================================</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># test simple jac</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co"># provided jocabiean and mathematical</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">Phi_fn &lt;-<span class="st"> </span><span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>theta <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>lambda</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">Psi_fn &lt;-<span class="st"> </span><span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>lambda <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>theta</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">res &lt;-<span class="st"> </span><span class="kw">semislv</span>(<span class="dv">1</span>, <span class="dv">1</span>, Phi_fn, Psi_fn, <span class="dt">method =</span> <span class="st">&quot;implicit&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">res &lt;-<span class="st"> </span><span class="kw">semislv</span>(<span class="dv">1</span>, <span class="dv">1</span>, Phi_fn, Psi_fn, <span class="dt">jac =</span> <span class="kw">list</span>(<span class="dt">Phi_der_theta_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span>, <span class="dt">Phi_der_lambda_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) alpha, <span class="dt">Psi_der_theta_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) alpha, <span class="dt">Psi_der_lambda_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span>), <span class="dt">method =</span> <span class="st">&quot;implicit&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">res &lt;-<span class="st"> </span><span class="kw">semislv</span>(<span class="dv">1</span>, <span class="dv">1</span>, Phi_fn, Psi_fn, <span class="dt">jac =</span> <span class="kw">list</span>(<span class="dt">Phi_der_theta_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span>, <span class="dt">Phi_der_lambda_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) alpha, <span class="dt">Psi_der_theta_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) alpha, <span class="dt">Psi_der_lambda_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span>), <span class="dt">method =</span> <span class="st">&quot;iterative&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13"></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">Newton &lt;-<span class="st"> </span><span class="cf">function</span>(beta0, alpha) {</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">        H_GS &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">2</span>, alpha, alpha, <span class="dv">2</span>), <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">ncol =</span> <span class="dv">2</span>) <span class="co"># Hessian Matrix</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">        beta_GS &lt;-<span class="st"> </span>beta0</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">        step_GS &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">        series &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">        t0 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">        f &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">                <span class="kw">return</span>(<span class="kw">c</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>y, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>y <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>x))</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">        } <span class="co"># the target function</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">        <span class="cf">while</span> (<span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">                bscore &lt;-<span class="st"> </span><span class="kw">f</span>(beta_GS[<span class="dv">1</span>], beta_GS[<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">                <span class="cf">if</span> (<span class="kw">all</span>(<span class="kw">abs</span>(bscore) <span class="op">&lt;</span><span class="st"> </span><span class="fl">1e-7</span>)) <span class="cf">break</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">                beta_GS &lt;-<span class="st"> </span>beta_GS <span class="op">-</span><span class="st"> </span><span class="kw">solve</span>(H_GS, bscore) <span class="co"># NR iteration</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28">                step_GS &lt;-<span class="st"> </span>step_GS <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">                series &lt;-<span class="st"> </span><span class="kw">rbind</span>(series, beta_GS)</a>
<a class="sourceLine" id="cb2-30" data-line-number="30">        }</a>
<a class="sourceLine" id="cb2-31" data-line-number="31"></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">        run_time_GS &lt;-<span class="st"> </span><span class="kw">Sys.time</span>() <span class="op">-</span><span class="st"> </span>t0</a>
<a class="sourceLine" id="cb2-33" data-line-number="33">        <span class="kw">return</span>(<span class="kw">list</span>(</a>
<a class="sourceLine" id="cb2-34" data-line-number="34">                <span class="dt">beta =</span> beta_GS, <span class="dt">step =</span> step_GS, <span class="dt">run_time =</span> run_time_GS,</a>
<a class="sourceLine" id="cb2-35" data-line-number="35">                <span class="dt">series =</span> series</a>
<a class="sourceLine" id="cb2-36" data-line-number="36">        ))</a>
<a class="sourceLine" id="cb2-37" data-line-number="37">}</a>
<a class="sourceLine" id="cb2-38" data-line-number="38"></a>
<a class="sourceLine" id="cb2-39" data-line-number="39">get_fit_from_raw &lt;-<span class="st"> </span><span class="cf">function</span>(raw_fit) {</a>
<a class="sourceLine" id="cb2-40" data-line-number="40">        fit &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb2-41" data-line-number="41">        fit<span class="op">$</span>beta &lt;-<span class="st"> </span><span class="kw">c</span>(raw_fit<span class="op">$</span>parameters<span class="op">$</span>theta, raw_fit<span class="op">$</span>parameters<span class="op">$</span>lambda)</a>
<a class="sourceLine" id="cb2-42" data-line-number="42">        fit<span class="op">$</span>step &lt;-<span class="st"> </span>raw_fit<span class="op">$</span>step</a>
<a class="sourceLine" id="cb2-43" data-line-number="43">        fit<span class="op">$</span>run_time &lt;-<span class="st"> </span>raw_fit<span class="op">$</span>run.time</a>
<a class="sourceLine" id="cb2-44" data-line-number="44">        series &lt;-<span class="st"> </span><span class="kw">c</span>(res<span class="op">$</span>iterspace<span class="op">$</span>initials<span class="op">$</span>theta, res<span class="op">$</span>iterspace<span class="op">$</span>initials<span class="op">$</span>lambda)</a>
<a class="sourceLine" id="cb2-45" data-line-number="45">        purrr<span class="op">::</span><span class="kw">walk</span>(raw_fit<span class="op">$</span>res_path, <span class="cf">function</span>(x) series &lt;&lt;-<span class="st"> </span><span class="kw">rbind</span>(series, <span class="kw">c</span>(x<span class="op">$</span>parameters<span class="op">$</span>theta, x<span class="op">$</span>parameters<span class="op">$</span>lambda)))</a>
<a class="sourceLine" id="cb2-46" data-line-number="46">        fit<span class="op">$</span>series &lt;-<span class="st"> </span>series</a>
<a class="sourceLine" id="cb2-47" data-line-number="47">        fit</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">}</a>
<a class="sourceLine" id="cb2-49" data-line-number="49"></a>
<a class="sourceLine" id="cb2-50" data-line-number="50"></a>
<a class="sourceLine" id="cb2-51" data-line-number="51">run_Ip &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates, theta, lambda, alpha) {</a>
<a class="sourceLine" id="cb2-52" data-line-number="52">        x &lt;-<span class="st"> </span>theta</a>
<a class="sourceLine" id="cb2-53" data-line-number="53">        y &lt;-<span class="st"> </span>lambda</a>
<a class="sourceLine" id="cb2-54" data-line-number="54">        yscore &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>y <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb2-55" data-line-number="55">        intermediates<span class="op">$</span>y_delta &lt;-<span class="st"> </span><span class="op">-</span>yscore <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="co"># IP lambda iteration</span></a>
<a class="sourceLine" id="cb2-56" data-line-number="56">        y &lt;-<span class="st"> </span>y <span class="op">+</span><span class="st"> </span>intermediates<span class="op">$</span>y_delta</a>
<a class="sourceLine" id="cb2-57" data-line-number="57">        xscore &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb2-58" data-line-number="58">        intermediates<span class="op">$</span>x_delta &lt;-<span class="st"> </span><span class="dv">-2</span> <span class="op">*</span><span class="st"> </span>xscore <span class="op">/</span><span class="st"> </span>(<span class="dv">4</span> <span class="op">-</span><span class="st"> </span>alpha<span class="op">^</span><span class="dv">2</span>) <span class="co"># IP theta iteration</span></a>
<a class="sourceLine" id="cb2-59" data-line-number="59">        intermediates</a>
<a class="sourceLine" id="cb2-60" data-line-number="60">}</a>
<a class="sourceLine" id="cb2-61" data-line-number="61"></a>
<a class="sourceLine" id="cb2-62" data-line-number="62">theta_delta_Ip &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates) {</a>
<a class="sourceLine" id="cb2-63" data-line-number="63">        intermediates<span class="op">$</span>theta_delta &lt;-<span class="st"> </span>intermediates<span class="op">$</span>x_delta</a>
<a class="sourceLine" id="cb2-64" data-line-number="64">        intermediates</a>
<a class="sourceLine" id="cb2-65" data-line-number="65">}</a>
<a class="sourceLine" id="cb2-66" data-line-number="66"></a>
<a class="sourceLine" id="cb2-67" data-line-number="67">lambda_delta_Ip &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates) {</a>
<a class="sourceLine" id="cb2-68" data-line-number="68">        intermediates<span class="op">$</span>lambda_delta &lt;-<span class="st"> </span>intermediates<span class="op">$</span>y_delta</a>
<a class="sourceLine" id="cb2-69" data-line-number="69">        intermediates</a>
<a class="sourceLine" id="cb2-70" data-line-number="70">}</a>
<a class="sourceLine" id="cb2-71" data-line-number="71"></a>
<a class="sourceLine" id="cb2-72" data-line-number="72">run_It &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates, theta, lambda, alpha) {</a>
<a class="sourceLine" id="cb2-73" data-line-number="73">        x &lt;-<span class="st"> </span>theta</a>
<a class="sourceLine" id="cb2-74" data-line-number="74">        y &lt;-<span class="st"> </span>lambda</a>
<a class="sourceLine" id="cb2-75" data-line-number="75">        yscore &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>y <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb2-76" data-line-number="76">        intermediates<span class="op">$</span>y_delta &lt;-<span class="st"> </span><span class="op">-</span>yscore <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="co"># IP lambda iteration</span></a>
<a class="sourceLine" id="cb2-77" data-line-number="77">        y &lt;-<span class="st"> </span>y <span class="op">+</span><span class="st"> </span>intermediates<span class="op">$</span>y_delta</a>
<a class="sourceLine" id="cb2-78" data-line-number="78">        xscore &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>alpha <span class="op">*</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb2-79" data-line-number="79">        intermediates<span class="op">$</span>x_delta &lt;-<span class="st"> </span><span class="op">-</span>xscore <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="co">#-2 * xscore / (4 - alpha^2) # IP theta iteration</span></a>
<a class="sourceLine" id="cb2-80" data-line-number="80">        intermediates</a>
<a class="sourceLine" id="cb2-81" data-line-number="81">}</a>
<a class="sourceLine" id="cb2-82" data-line-number="82"></a>
<a class="sourceLine" id="cb2-83" data-line-number="83">theta_delta_It &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates) {</a>
<a class="sourceLine" id="cb2-84" data-line-number="84">        intermediates<span class="op">$</span>theta_delta &lt;-<span class="st"> </span>intermediates<span class="op">$</span>x_delta</a>
<a class="sourceLine" id="cb2-85" data-line-number="85">        intermediates</a>
<a class="sourceLine" id="cb2-86" data-line-number="86">}</a>
<a class="sourceLine" id="cb2-87" data-line-number="87"></a>
<a class="sourceLine" id="cb2-88" data-line-number="88">lambda_delta_It &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates) {</a>
<a class="sourceLine" id="cb2-89" data-line-number="89">        intermediates<span class="op">$</span>lambda_delta &lt;-<span class="st"> </span>intermediates<span class="op">$</span>y_delta</a>
<a class="sourceLine" id="cb2-90" data-line-number="90">        intermediates</a>
<a class="sourceLine" id="cb2-91" data-line-number="91">}</a></code></pre></div>
</div>
<div id="simulation" class="section level2">
<h2>Simulation</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">j &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">step_all &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">series_all &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">direction_all &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="cf">for</span> (k <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="fl">1.0</span>, <span class="fl">1.2</span>, <span class="fl">1.4</span>, <span class="fl">1.6</span>, <span class="fl">1.8</span>)) {</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">        step &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">        series &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">        direction &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">        length &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">        theta &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>base<span class="op">::</span>pi, <span class="dt">length.out =</span> length)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">        alpha &lt;-<span class="st"> </span>k</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) {</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">                C &lt;-<span class="st"> </span>i<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">                x &lt;-<span class="st"> </span>(<span class="kw">sqrt</span>(C <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">*</span><span class="st"> </span><span class="kw">cos</span>(theta) <span class="op">+</span><span class="st"> </span><span class="kw">sqrt</span>(C <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">*</span><span class="st"> </span><span class="kw">sin</span>(theta)) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">2</span> <span class="op">-</span><span class="st"> </span>alpha<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">                y &lt;-<span class="st"> </span>(<span class="kw">sqrt</span>(C <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">*</span><span class="st"> </span><span class="kw">cos</span>(theta) <span class="op">-</span><span class="st"> </span><span class="kw">sqrt</span>(C <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">*</span><span class="st"> </span><span class="kw">sin</span>(theta)) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">2</span> <span class="op">-</span><span class="st"> </span>alpha<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">                sub_step &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">ncol =</span> length)</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">                sub_series &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">                k1 &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">                k2 &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">                k3 &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-21" data-line-number="21">                sub_direction &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">                <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>length) {</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">                        beta0 &lt;-<span class="st"> </span><span class="kw">c</span>(x[ii], y[ii])</a>
<a class="sourceLine" id="cb3-24" data-line-number="24">                        Newton_fit &lt;-<span class="st"> </span><span class="kw">Newton</span>(beta0, alpha)</a>
<a class="sourceLine" id="cb3-25" data-line-number="25">                        Ip_raw_fit &lt;-<span class="st"> </span><span class="kw">semislv</span>(<span class="dt">theta =</span> beta0[<span class="dv">1</span>], <span class="dt">lambda =</span> beta0[<span class="dv">2</span>], Phi_fn, Psi_fn, <span class="dt">jac =</span> <span class="kw">list</span>(<span class="dt">Phi_der_theta_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span>, <span class="dt">Phi_der_lambda_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) alpha, <span class="dt">Psi_der_theta_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) alpha, <span class="dt">Psi_der_lambda_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span>), <span class="dt">method =</span> <span class="st">&quot;implicit&quot;</span>, <span class="dt">alpha =</span> alpha, <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">max_iter =</span> <span class="dv">100</span>, <span class="dt">tol =</span> <span class="fl">1e-7</span>))</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">                        Ip_fit &lt;-<span class="st"> </span><span class="kw">get_fit_from_raw</span>(Ip_raw_fit)</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">                        It_raw_fit &lt;-<span class="st"> </span><span class="kw">semislv</span>(<span class="dt">theta =</span> beta0[<span class="dv">1</span>], <span class="dt">lambda =</span> beta0[<span class="dv">2</span>], Phi_fn, Psi_fn, <span class="dt">jac =</span> <span class="kw">list</span>(<span class="dt">Phi_der_theta_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span>, <span class="dt">Phi_der_lambda_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) alpha, <span class="dt">Psi_der_theta_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) alpha, <span class="dt">Psi_der_lambda_fn =</span> <span class="cf">function</span>(theta, lambda, alpha) <span class="dv">2</span>), <span class="dt">method =</span> <span class="st">&quot;iterative&quot;</span>, <span class="dt">alpha =</span> alpha, <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">max_iter =</span> <span class="dv">100</span>, <span class="dt">tol =</span> <span class="fl">1e-7</span>))</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">                        It_fit &lt;-<span class="st"> </span><span class="kw">get_fit_from_raw</span>(It_raw_fit)</a>
<a class="sourceLine" id="cb3-29" data-line-number="29">                        sub_step[, ii] &lt;-<span class="st"> </span><span class="kw">c</span>(Newton_fit<span class="op">$</span>step, It_fit<span class="op">$</span>step, Ip_fit<span class="op">$</span>step)</a>
<a class="sourceLine" id="cb3-30" data-line-number="30">                        k1[[ii]] &lt;-<span class="st"> </span>Newton_fit<span class="op">$</span>series</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">                        k2[[ii]] &lt;-<span class="st"> </span>It_fit<span class="op">$</span>series</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">                        k3[[ii]] &lt;-<span class="st"> </span>Ip_fit<span class="op">$</span>series</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">                        sub_direction[[ii]] &lt;-<span class="st"> </span>It_fit<span class="op">$</span>direction</a>
<a class="sourceLine" id="cb3-34" data-line-number="34">                }</a>
<a class="sourceLine" id="cb3-35" data-line-number="35">                step[[i]] &lt;-<span class="st"> </span>sub_step</a>
<a class="sourceLine" id="cb3-36" data-line-number="36">                sub_series[[<span class="st">&quot;Newton&quot;</span>]] &lt;-<span class="st"> </span>k1</a>
<a class="sourceLine" id="cb3-37" data-line-number="37">                sub_series[[<span class="st">&quot;It&quot;</span>]] &lt;-<span class="st"> </span>k2</a>
<a class="sourceLine" id="cb3-38" data-line-number="38">                sub_series[[<span class="st">&quot;Ip&quot;</span>]] &lt;-<span class="st"> </span>k3</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">                series[[i]] &lt;-<span class="st"> </span>sub_series</a>
<a class="sourceLine" id="cb3-40" data-line-number="40">                direction[[i]] &lt;-<span class="st"> </span>sub_direction</a>
<a class="sourceLine" id="cb3-41" data-line-number="41">        }</a>
<a class="sourceLine" id="cb3-42" data-line-number="42">        step_all[[j]] &lt;-<span class="st"> </span>step</a>
<a class="sourceLine" id="cb3-43" data-line-number="43">        series_all[[j]] &lt;-<span class="st"> </span>series</a>
<a class="sourceLine" id="cb3-44" data-line-number="44">        direction_all[[j]] &lt;-<span class="st"> </span>direction</a>
<a class="sourceLine" id="cb3-45" data-line-number="45">        j &lt;-<span class="st"> </span>j <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-46" data-line-number="46">}</a></code></pre></div>
</div>
<div id="output" class="section level2">
<h2>Output</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">Newton_Raphson =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">IT_step =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">IP_step =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) {</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">        k &lt;-<span class="st"> </span>step_all[[i]]</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">        s &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(k)) {</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">                s &lt;-<span class="st"> </span><span class="kw">cbind</span>(s, k[[j]])</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">        }</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">        tmp =<span class="st"> </span><span class="kw">apply</span>(s, <span class="dv">1</span>, mean)</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">        <span class="kw">print</span>(tmp)</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">        Newton_Raphson =<span class="st"> </span><span class="kw">c</span>(Newton_Raphson, tmp[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">        IT_step =<span class="st"> </span><span class="kw">c</span>(IT_step, tmp[<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">        IP_step =<span class="st"> </span><span class="kw">c</span>(IP_step, tmp[<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; [1] 1 1 1</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt; [1] 1.00 4.78 2.00</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; [1] 1.00 6.19 2.00</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; [1] 1.00 7.95 2.00</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#&gt; [1]  1.00 10.28  2.00</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">#&gt; [1]  1.00 13.19  1.90</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">#&gt; [1]  1.0 17.4  2.0</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">#&gt; [1]  1.0 24.2  2.0</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="co">#&gt; [1]  1.00 37.55  2.00</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co">#&gt; [1]  1.00 77.32  2.00</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"></a>
<a class="sourceLine" id="cb4-27" data-line-number="27">k &lt;-<span class="st"> </span>step_all[[<span class="dv">9</span>]]</a>
<a class="sourceLine" id="cb4-28" data-line-number="28">k &lt;-<span class="st"> </span><span class="kw">lapply</span>(k, apply, <span class="dv">1</span>, mean)</a>
<a class="sourceLine" id="cb4-29" data-line-number="29">s &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) {</a>
<a class="sourceLine" id="cb4-31" data-line-number="31">        s &lt;-<span class="st"> </span><span class="kw">rbind</span>(s, k[[i]])</a>
<a class="sourceLine" id="cb4-32" data-line-number="32">}</a>
<a class="sourceLine" id="cb4-33" data-line-number="33"><span class="kw">print</span>(s)</a>
<a class="sourceLine" id="cb4-34" data-line-number="34"><span class="co">#&gt;       [,1] [,2] [,3]</span></a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="co">#&gt;  [1,]    1 34.2    2</span></a>
<a class="sourceLine" id="cb4-36" data-line-number="36"><span class="co">#&gt;  [2,]    1 35.6    2</span></a>
<a class="sourceLine" id="cb4-37" data-line-number="37"><span class="co">#&gt;  [3,]    1 36.5    2</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38"><span class="co">#&gt;  [4,]    1 37.2    2</span></a>
<a class="sourceLine" id="cb4-39" data-line-number="39"><span class="co">#&gt;  [5,]    1 37.9    2</span></a>
<a class="sourceLine" id="cb4-40" data-line-number="40"><span class="co">#&gt;  [6,]    1 38.2    2</span></a>
<a class="sourceLine" id="cb4-41" data-line-number="41"><span class="co">#&gt;  [7,]    1 38.4    2</span></a>
<a class="sourceLine" id="cb4-42" data-line-number="42"><span class="co">#&gt;  [8,]    1 38.9    2</span></a>
<a class="sourceLine" id="cb4-43" data-line-number="43"><span class="co">#&gt;  [9,]    1 39.2    2</span></a>
<a class="sourceLine" id="cb4-44" data-line-number="44"><span class="co">#&gt; [10,]    1 39.4    2</span></a>
<a class="sourceLine" id="cb4-45" data-line-number="45">Newton_Raphson =<span class="st"> </span>s[, <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb4-46" data-line-number="46">IP_step =<span class="st"> </span>s[, <span class="dv">3</span>]</a>
<a class="sourceLine" id="cb4-47" data-line-number="47">IT_step =<span class="st"> </span>s[, <span class="dv">2</span>]</a></code></pre></div>
</div>
</div>
<div id="risk-prediction-model" class="section level1">
<h1>Risk Prediction Model</h1>
<div id="code-1" class="section level2">
<h2>Code</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">library</span>(SemiEstimate)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">library</span>(nleqslv)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># Data processure</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">sim.gen.STM &lt;-<span class="st"> </span><span class="cf">function</span>(n, p, beta0, sigmaZ, <span class="dt">Nperturb =</span> <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  Z &lt;-<span class="st"> </span><span class="kw">mvrnorm</span>(n, <span class="kw">rep</span>(<span class="dv">0</span>, p), sigmaZ<span class="op">^</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(<span class="fl">0.2</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.8</span> <span class="op">*</span><span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span>, p)))</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  u &lt;-<span class="st"> </span><span class="kw">runif</span>(n)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  T &lt;-<span class="st"> </span><span class="kw">exp</span>((<span class="kw">log</span>(u <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>u)) <span class="op">-</span><span class="st"> </span>Z <span class="op">%*%</span><span class="st"> </span>beta0) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>) <span class="op">*</span><span class="st"> </span><span class="dv">4</span> <span class="co"># h^-1 (g^-1(u) - beta'Z)</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  C &lt;-<span class="st"> </span><span class="kw">runif</span>(n, <span class="dv">0</span>, <span class="dv">12</span>)</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  delta &lt;-<span class="st"> </span>(T <span class="op">&lt;=</span><span class="st"> </span>C)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb5-11" data-line-number="11">  <span class="kw">return</span>(<span class="kw">list</span>(</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    <span class="dt">delta =</span> delta, <span class="dt">C =</span> C,</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    <span class="dt">Z =</span> Z</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">  ))</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb5-16" data-line-number="16"></a>
<a class="sourceLine" id="cb5-17" data-line-number="17">f =<span class="st"> </span><span class="cf">function</span>(parameters, delta, Z, KC, N, p)</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">{ </a>
<a class="sourceLine" id="cb5-19" data-line-number="19">  <span class="co"># parameters contain beta and h</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20">  beta =<span class="st"> </span>parameters[<span class="dv">1</span><span class="op">:</span>p]</a>
<a class="sourceLine" id="cb5-21" data-line-number="21">  h =<span class="st"> </span>parameters[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span>p)]</a>
<a class="sourceLine" id="cb5-22" data-line-number="22">  pi =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">return</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span><span class="op">+</span><span class="kw">exp</span>(<span class="op">-</span>x)))</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">  </a>
<a class="sourceLine" id="cb5-24" data-line-number="24">  line =<span class="st"> </span>Z <span class="op">%*%</span><span class="st"> </span>beta</a>
<a class="sourceLine" id="cb5-25" data-line-number="25">  <span class="co"># line is a N*1 vector</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26">  </a>
<a class="sourceLine" id="cb5-27" data-line-number="27">  reg =<span class="st"> </span><span class="kw">outer</span>(h, line, <span class="st">&quot;+&quot;</span>)[,,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb5-28" data-line-number="28">  reg_pi =<span class="st"> </span><span class="kw">pi</span>(reg)</a>
<a class="sourceLine" id="cb5-29" data-line-number="29">  <span class="co"># reg is a N*N matrix</span></a>
<a class="sourceLine" id="cb5-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb5-31" data-line-number="31">  dif =<span class="st"> </span><span class="kw">as.vector</span>(delta) <span class="op">-</span><span class="st"> </span><span class="kw">t</span>(reg_pi)</a>
<a class="sourceLine" id="cb5-32" data-line-number="32">  f1 =<span class="st"> </span>Z <span class="op">*</span><span class="st"> </span><span class="kw">diag</span>(dif)</a>
<a class="sourceLine" id="cb5-33" data-line-number="33">  f1 =<span class="st"> </span><span class="kw">apply</span>(f1, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb5-34" data-line-number="34">  f2 =<span class="st"> </span>KC <span class="op">*</span><span class="st"> </span>dif</a>
<a class="sourceLine" id="cb5-35" data-line-number="35">  f2 =<span class="st"> </span><span class="kw">apply</span>(f2, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb5-36" data-line-number="36">  </a>
<a class="sourceLine" id="cb5-37" data-line-number="37">  <span class="kw">return</span>(<span class="kw">c</span>(f1, f2))</a>
<a class="sourceLine" id="cb5-38" data-line-number="38">}</a>
<a class="sourceLine" id="cb5-39" data-line-number="39"></a>
<a class="sourceLine" id="cb5-40" data-line-number="40">global &lt;-<span class="st"> </span><span class="cf">function</span>(init, f, delta, Z, KC, N, p) {</a>
<a class="sourceLine" id="cb5-41" data-line-number="41">  t0 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb5-42" data-line-number="42">  out &lt;-<span class="st"> </span><span class="kw">nleqslv</span>(init, f,</a>
<a class="sourceLine" id="cb5-43" data-line-number="43">                          <span class="dt">delta =</span> delta, <span class="dt">Z =</span> Z, <span class="dt">KC =</span> KC,</a>
<a class="sourceLine" id="cb5-44" data-line-number="44">                          <span class="dt">N =</span> N, <span class="dt">p =</span> p, <span class="dt">method =</span> <span class="st">&quot;Newton&quot;</span>, <span class="dt">global =</span> <span class="st">&quot;none&quot;</span></a>
<a class="sourceLine" id="cb5-45" data-line-number="45">  )</a>
<a class="sourceLine" id="cb5-46" data-line-number="46">  run.time &lt;-<span class="st"> </span><span class="kw">Sys.time</span>() <span class="op">-</span><span class="st"> </span>t0</a>
<a class="sourceLine" id="cb5-47" data-line-number="47">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="dt">Model =</span> out, <span class="dt">run.time =</span> run.time))</a>
<a class="sourceLine" id="cb5-48" data-line-number="48">}</a>
<a class="sourceLine" id="cb5-49" data-line-number="49"></a>
<a class="sourceLine" id="cb5-50" data-line-number="50">expit =<span class="st"> </span><span class="cf">function</span>(d) <span class="kw">return</span>(<span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span><span class="op">+</span><span class="kw">exp</span>(<span class="op">-</span>d)))</a>
<a class="sourceLine" id="cb5-51" data-line-number="51"></a>
<a class="sourceLine" id="cb5-52" data-line-number="52">pi &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>x))</a>
<a class="sourceLine" id="cb5-53" data-line-number="53"></a>
<a class="sourceLine" id="cb5-54" data-line-number="54">Psi_fn &lt;-<span class="st"> </span><span class="cf">function</span>(theta, lambda, delta, Z, KC, N, p) {</a>
<a class="sourceLine" id="cb5-55" data-line-number="55">  line &lt;-<span class="st"> </span>Z <span class="op">%*%</span><span class="st"> </span>beta</a>
<a class="sourceLine" id="cb5-56" data-line-number="56">  reg &lt;-<span class="st"> </span><span class="kw">outer</span>(lambda, line, <span class="st">&quot;+&quot;</span>)[, , <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb5-57" data-line-number="57">  reg_pi &lt;-<span class="st"> </span><span class="kw">pi</span>(reg)</a>
<a class="sourceLine" id="cb5-58" data-line-number="58">  dif &lt;-<span class="st"> </span><span class="kw">as.vector</span>(delta) <span class="op">-</span><span class="st"> </span><span class="kw">t</span>(reg_pi)</a>
<a class="sourceLine" id="cb5-59" data-line-number="59">  <span class="kw">apply</span>(Z <span class="op">*</span><span class="st"> </span><span class="kw">diag</span>(dif), <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb5-60" data-line-number="60">}</a>
<a class="sourceLine" id="cb5-61" data-line-number="61"></a>
<a class="sourceLine" id="cb5-62" data-line-number="62">Phi_fn &lt;-<span class="st"> </span><span class="cf">function</span>(theta, lambda, delta, Z, KC, N, p) {</a>
<a class="sourceLine" id="cb5-63" data-line-number="63">  line &lt;-<span class="st"> </span>Z <span class="op">%*%</span><span class="st"> </span>beta</a>
<a class="sourceLine" id="cb5-64" data-line-number="64">  reg &lt;-<span class="st"> </span><span class="kw">outer</span>(lambda, line, <span class="st">&quot;+&quot;</span>)[, , <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb5-65" data-line-number="65">  reg_pi &lt;-<span class="st"> </span><span class="kw">pi</span>(reg)</a>
<a class="sourceLine" id="cb5-66" data-line-number="66">  dif &lt;-<span class="st"> </span><span class="kw">as.vector</span>(delta) <span class="op">-</span><span class="st"> </span><span class="kw">t</span>(reg_pi)</a>
<a class="sourceLine" id="cb5-67" data-line-number="67">  <span class="kw">apply</span>(KC <span class="op">*</span><span class="st"> </span>dif, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb5-68" data-line-number="68">}</a>
<a class="sourceLine" id="cb5-69" data-line-number="69"></a>
<a class="sourceLine" id="cb5-70" data-line-number="70"><span class="co"># ===========================================</span></a>
<a class="sourceLine" id="cb5-71" data-line-number="71"><span class="co"># ================ Implicit =================</span></a>
<a class="sourceLine" id="cb5-72" data-line-number="72"><span class="co"># ===========================================</span></a>
<a class="sourceLine" id="cb5-73" data-line-number="73"></a>
<a class="sourceLine" id="cb5-74" data-line-number="74">run_time.ip &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates, theta, lambda, delta, Z, KC, Zd, KCd) {</a>
<a class="sourceLine" id="cb5-75" data-line-number="75">  beta &lt;-<span class="st"> </span>theta</a>
<a class="sourceLine" id="cb5-76" data-line-number="76">  hC &lt;-<span class="st"> </span>lambda</a>
<a class="sourceLine" id="cb5-77" data-line-number="77">  expit &lt;-<span class="st"> </span><span class="cf">function</span>(d) {</a>
<a class="sourceLine" id="cb5-78" data-line-number="78">    <span class="kw">return</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>d)))</a>
<a class="sourceLine" id="cb5-79" data-line-number="79">  }</a>
<a class="sourceLine" id="cb5-80" data-line-number="80">  lp &lt;-<span class="st"> </span><span class="kw">drop</span>(Z <span class="op">%*%</span><span class="st"> </span>beta)</a>
<a class="sourceLine" id="cb5-81" data-line-number="81">  <span class="co"># print(hC[hC.flag])</span></a>
<a class="sourceLine" id="cb5-82" data-line-number="82">  gij &lt;-<span class="st"> </span><span class="kw">expit</span>(<span class="kw">outer</span>(hC, lp, <span class="st">&quot;+&quot;</span>))</a>
<a class="sourceLine" id="cb5-83" data-line-number="83">  tmp &lt;-<span class="st"> </span>KC <span class="op">*</span><span class="st"> </span>gij</a>
<a class="sourceLine" id="cb5-84" data-line-number="84">  wZbar &lt;-<span class="st"> </span>tmp <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>gij)</a>
<a class="sourceLine" id="cb5-85" data-line-number="85">  hscore &lt;-<span class="st"> </span><span class="kw">apply</span>(tmp, <span class="dv">1</span>, sum) <span class="op">-</span><span class="st"> </span>KCd</a>
<a class="sourceLine" id="cb5-86" data-line-number="86">  hHess &lt;-<span class="st"> </span><span class="kw">apply</span>(wZbar, <span class="dv">1</span>, sum)</a>
<a class="sourceLine" id="cb5-87" data-line-number="87">  </a>
<a class="sourceLine" id="cb5-88" data-line-number="88">  dhC &lt;-<span class="st"> </span>hscore <span class="op">/</span><span class="st"> </span>hHess</a>
<a class="sourceLine" id="cb5-89" data-line-number="89">  dhC &lt;-<span class="st"> </span><span class="kw">sign</span>(dhC) <span class="op">*</span><span class="st"> </span><span class="kw">pmin</span>(<span class="kw">abs</span>(dhC), <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-90" data-line-number="90">  intermediates<span class="op">$</span>dhC &lt;-<span class="st"> </span>dhC</a>
<a class="sourceLine" id="cb5-91" data-line-number="91">  hC &lt;-<span class="st"> </span>hC <span class="op">-</span><span class="st"> </span>dhC</a>
<a class="sourceLine" id="cb5-92" data-line-number="92">  Zbar &lt;-<span class="st"> </span>(wZbar <span class="op">%*%</span><span class="st"> </span>Z) <span class="op">/</span><span class="st"> </span>hHess</a>
<a class="sourceLine" id="cb5-93" data-line-number="93">  </a>
<a class="sourceLine" id="cb5-94" data-line-number="94">  gi &lt;-<span class="st"> </span><span class="kw">expit</span>(hC <span class="op">+</span><span class="st"> </span>lp)</a>
<a class="sourceLine" id="cb5-95" data-line-number="95">  bscore &lt;-<span class="st"> </span><span class="kw">drop</span>(<span class="kw">t</span>(Z) <span class="op">%*%</span><span class="st"> </span>(delta <span class="op">-</span><span class="st"> </span>gi))</a>
<a class="sourceLine" id="cb5-96" data-line-number="96">  </a>
<a class="sourceLine" id="cb5-97" data-line-number="97">  bHess &lt;-<span class="st"> </span><span class="kw">t</span>(gi <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>gi) <span class="op">*</span><span class="st"> </span>Z) <span class="op">%*%</span><span class="st"> </span>(Zbar <span class="op">-</span><span class="st"> </span>Z)</a>
<a class="sourceLine" id="cb5-98" data-line-number="98">  dinit &lt;-<span class="st"> </span><span class="kw">solve</span>(bHess, bscore)</a>
<a class="sourceLine" id="cb5-99" data-line-number="99">  </a>
<a class="sourceLine" id="cb5-100" data-line-number="100">  intermediates<span class="op">$</span>dinit &lt;-<span class="st"> </span>dinit</a>
<a class="sourceLine" id="cb5-101" data-line-number="101">  intermediates</a>
<a class="sourceLine" id="cb5-102" data-line-number="102">}</a>
<a class="sourceLine" id="cb5-103" data-line-number="103"></a>
<a class="sourceLine" id="cb5-104" data-line-number="104">theta_delta.ip &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates) {</a>
<a class="sourceLine" id="cb5-105" data-line-number="105">  intermediates<span class="op">$</span>theta_delta &lt;-<span class="st"> </span><span class="op">-</span>intermediates<span class="op">$</span>dinit</a>
<a class="sourceLine" id="cb5-106" data-line-number="106">  intermediates</a>
<a class="sourceLine" id="cb5-107" data-line-number="107">}</a>
<a class="sourceLine" id="cb5-108" data-line-number="108"></a>
<a class="sourceLine" id="cb5-109" data-line-number="109">lambda_delta.ip &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates) {</a>
<a class="sourceLine" id="cb5-110" data-line-number="110">  intermediates<span class="op">$</span>lambda_delta &lt;-<span class="st"> </span><span class="op">-</span>intermediates<span class="op">$</span>dhC</a>
<a class="sourceLine" id="cb5-111" data-line-number="111">  intermediates</a>
<a class="sourceLine" id="cb5-112" data-line-number="112">}</a>
<a class="sourceLine" id="cb5-113" data-line-number="113"></a>
<a class="sourceLine" id="cb5-114" data-line-number="114"></a>
<a class="sourceLine" id="cb5-115" data-line-number="115"><span class="co"># ======================================</span></a>
<a class="sourceLine" id="cb5-116" data-line-number="116"><span class="co"># ============= Iterative ==============</span></a>
<a class="sourceLine" id="cb5-117" data-line-number="117"><span class="co"># ======================================</span></a>
<a class="sourceLine" id="cb5-118" data-line-number="118"></a>
<a class="sourceLine" id="cb5-119" data-line-number="119">run_time.it &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates, lambda, theta, Z, KC, Zd, KCd) {</a>
<a class="sourceLine" id="cb5-120" data-line-number="120">  beta &lt;-<span class="st"> </span>theta</a>
<a class="sourceLine" id="cb5-121" data-line-number="121">  hC &lt;-<span class="st"> </span>lambda</a>
<a class="sourceLine" id="cb5-122" data-line-number="122">  expit &lt;-<span class="st"> </span><span class="cf">function</span>(d) {</a>
<a class="sourceLine" id="cb5-123" data-line-number="123">    <span class="kw">return</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>d)))</a>
<a class="sourceLine" id="cb5-124" data-line-number="124">  }</a>
<a class="sourceLine" id="cb5-125" data-line-number="125">  </a>
<a class="sourceLine" id="cb5-126" data-line-number="126">  f_beta &lt;-<span class="st"> </span><span class="cf">function</span>(beta, hC, gi) {</a>
<a class="sourceLine" id="cb5-127" data-line-number="127">    temp_pi &lt;-<span class="st"> </span><span class="kw">t</span>(Z) <span class="op">%*%</span><span class="st"> </span>gi</a>
<a class="sourceLine" id="cb5-128" data-line-number="128">    <span class="kw">return</span>(Zd <span class="op">-</span><span class="st"> </span>temp_pi)</a>
<a class="sourceLine" id="cb5-129" data-line-number="129">  }</a>
<a class="sourceLine" id="cb5-130" data-line-number="130">  </a>
<a class="sourceLine" id="cb5-131" data-line-number="131">  jacf_beta &lt;-<span class="st"> </span><span class="cf">function</span>(beta, hC, gi) {</a>
<a class="sourceLine" id="cb5-132" data-line-number="132">    bHess &lt;-<span class="st"> </span><span class="kw">t</span>(gi <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>gi) <span class="op">*</span><span class="st"> </span>Z) <span class="op">%*%</span><span class="st"> </span>Z</a>
<a class="sourceLine" id="cb5-133" data-line-number="133">    <span class="kw">return</span>(<span class="op">-</span>bHess)</a>
<a class="sourceLine" id="cb5-134" data-line-number="134">  }</a>
<a class="sourceLine" id="cb5-135" data-line-number="135">  </a>
<a class="sourceLine" id="cb5-136" data-line-number="136">  f_hC &lt;-<span class="st"> </span><span class="cf">function</span>(hC, beta, gij, temp) {</a>
<a class="sourceLine" id="cb5-137" data-line-number="137">    <span class="kw">return</span>(<span class="kw">apply</span>(temp, <span class="dv">1</span>, sum) <span class="op">-</span><span class="st"> </span>KCd)</a>
<a class="sourceLine" id="cb5-138" data-line-number="138">  }</a>
<a class="sourceLine" id="cb5-139" data-line-number="139">  </a>
<a class="sourceLine" id="cb5-140" data-line-number="140">  jacf_hC &lt;-<span class="st"> </span><span class="cf">function</span>(hC, beta, gij, temp) {</a>
<a class="sourceLine" id="cb5-141" data-line-number="141">    wZbar &lt;-<span class="st"> </span>temp <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>gij)</a>
<a class="sourceLine" id="cb5-142" data-line-number="142">    hscore &lt;-<span class="st"> </span><span class="kw">apply</span>(temp, <span class="dv">1</span>, sum) <span class="op">-</span><span class="st"> </span>KCd</a>
<a class="sourceLine" id="cb5-143" data-line-number="143">    hHess &lt;-<span class="st"> </span><span class="kw">apply</span>(wZbar, <span class="dv">1</span>, sum)</a>
<a class="sourceLine" id="cb5-144" data-line-number="144">    hHess &lt;-<span class="st"> </span><span class="kw">diag</span>(hHess)</a>
<a class="sourceLine" id="cb5-145" data-line-number="145">    <span class="kw">return</span>(hHess)</a>
<a class="sourceLine" id="cb5-146" data-line-number="146">  }</a>
<a class="sourceLine" id="cb5-147" data-line-number="147">  intermediates<span class="op">$</span>gi &lt;-<span class="st"> </span><span class="kw">expit</span>(hC <span class="op">+</span><span class="st"> </span><span class="kw">drop</span>(Z <span class="op">%*%</span><span class="st"> </span>beta))</a>
<a class="sourceLine" id="cb5-148" data-line-number="148">  intermediates<span class="op">$</span>temp_beta &lt;-<span class="st"> </span><span class="kw">nleqslv</span>(beta, f_beta,</a>
<a class="sourceLine" id="cb5-149" data-line-number="149">                                              <span class="dt">jac =</span> jacf_beta,</a>
<a class="sourceLine" id="cb5-150" data-line-number="150">                                              <span class="dt">hC =</span> hC, <span class="dt">gi =</span> intermediates<span class="op">$</span>gi, <span class="dt">method =</span> <span class="st">&quot;Newton&quot;</span>,</a>
<a class="sourceLine" id="cb5-151" data-line-number="151">                                              <span class="dt">global =</span> <span class="st">&quot;none&quot;</span>, <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">maxit =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-152" data-line-number="152">  )</a>
<a class="sourceLine" id="cb5-153" data-line-number="153">  intermediates<span class="op">$</span>gij &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> n, <span class="dt">ncol =</span> n)</a>
<a class="sourceLine" id="cb5-154" data-line-number="154">  intermediates<span class="op">$</span>gij[<span class="dv">1</span><span class="op">:</span>n, ] &lt;-<span class="st"> </span><span class="kw">expit</span>(<span class="kw">outer</span>(hC, Z <span class="op">%*%</span><span class="st"> </span>intermediates<span class="op">$</span>temp_beta<span class="op">$</span>x, <span class="st">&quot;+&quot;</span>))</a>
<a class="sourceLine" id="cb5-155" data-line-number="155">  intermediates<span class="op">$</span>temp &lt;-<span class="st"> </span>KC <span class="op">*</span><span class="st"> </span>intermediates<span class="op">$</span>gij</a>
<a class="sourceLine" id="cb5-156" data-line-number="156">  intermediates<span class="op">$</span>temp_hC &lt;-<span class="st"> </span><span class="kw">nleqslv</span>(hC, f_hC,</a>
<a class="sourceLine" id="cb5-157" data-line-number="157">                                            <span class="dt">jac =</span> jacf_hC,</a>
<a class="sourceLine" id="cb5-158" data-line-number="158">                                            <span class="dt">beta =</span> temp_beta<span class="op">$</span>x, <span class="dt">gij =</span> intermediates<span class="op">$</span>gij, <span class="dt">temp =</span> intermediates<span class="op">$</span>temp, <span class="dt">method =</span> <span class="st">&quot;Newton&quot;</span>,</a>
<a class="sourceLine" id="cb5-159" data-line-number="159">                                            <span class="dt">global =</span> <span class="st">&quot;none&quot;</span>, <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">maxit =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-160" data-line-number="160">  )</a>
<a class="sourceLine" id="cb5-161" data-line-number="161">  intermediates</a>
<a class="sourceLine" id="cb5-162" data-line-number="162">}</a>
<a class="sourceLine" id="cb5-163" data-line-number="163">theta_delta.it &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates, theta) {</a>
<a class="sourceLine" id="cb5-164" data-line-number="164">  intermediates<span class="op">$</span>theta_delta &lt;-<span class="st"> </span>intermediates<span class="op">$</span>temp_beta<span class="op">$</span>x <span class="op">-</span><span class="st"> </span>theta</a>
<a class="sourceLine" id="cb5-165" data-line-number="165">  intermediates</a>
<a class="sourceLine" id="cb5-166" data-line-number="166">}</a>
<a class="sourceLine" id="cb5-167" data-line-number="167"></a>
<a class="sourceLine" id="cb5-168" data-line-number="168"></a>
<a class="sourceLine" id="cb5-169" data-line-number="169">lambda_delta.it &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates, lambda) {</a>
<a class="sourceLine" id="cb5-170" data-line-number="170">  intermediates<span class="op">$</span>lambda_delta &lt;-<span class="st"> </span>intermediates<span class="op">$</span>temp_hC<span class="op">$</span>x <span class="op">-</span><span class="st"> </span>lambda</a>
<a class="sourceLine" id="cb5-171" data-line-number="171">  intermediates</a>
<a class="sourceLine" id="cb5-172" data-line-number="172">}</a></code></pre></div>
</div>
<div id="simulation-1" class="section level2">
<h2>Simulation</h2>
<p><span class="math inline">\(N = 500\)</span></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">#nrep &lt;- 100 # 100</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#N &lt;- 500</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#p &lt;- 10</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#beta0 &lt;- c(0.7, 0.7, 0.7, -0.5, -0.5, -0.5, 0.3, 0.3, 0.3, 0)</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#sigmaZ &lt;- 1</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#set.seed(20210806)</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#compare &lt;- list()</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#time &lt;- matrix(nrow = nrep, ncol = 3)</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="co">#step &lt;- matrix(nrow = nrep, ncol = 3)</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co">#mse_global &lt;- 0</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="co">#mse_IP &lt;- 0</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="co">#mse_IT &lt;- 0</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="co">#</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="co">#for (i in 1:nrep) {</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="co">#  dat &lt;- sim.gen.STM(N, p, beta0, sigmaZ) ## don't change</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="co">#  h &lt;- sd(dat$C) / (sum(dat$delta))^0.25</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="co">#  KC &lt;- dnorm(as.matrix(dist(dat$C / h, diag = T, upper = T))) / h</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="co">#  KCd &lt;- drop(KC %*% dat$delta)</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="co">#  theta0 &lt;- rep(0, ncol(dat$Z))</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="co">#  n &lt;- nrow(dat$Z)</span></a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="co">#  Zd &lt;- drop(t(dat$Z) %*% dat$delta)</span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="co">#  lambda0 &lt;- rep(0, n)</span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="co">#  ## place my initial value</span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="co">#  out_global &lt;- global(rep(0, N + p), f, dat$delta, dat$Z, KC, N, p)</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26"><span class="co">#  ## return beta, runtime, step</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="co">#  intermediates.ip &lt;- list(hC = lambda0, beta = theta0)</span></a>
<a class="sourceLine" id="cb6-28" data-line-number="28"><span class="co">#  intermediates.it &lt;- list(hC = lambda0, beta = theta0)</span></a>
<a class="sourceLine" id="cb6-29" data-line-number="29"><span class="co">#  out_ip &lt;- semislv(theta = theta0, lambda = lambda0, Phi_fn = Phi_fn, Psi_fn = Psi_fn, method = &quot;implicit&quot;, diy = TRUE, Z = dat$Z, delta = dat$delta, KC = KC, n = n, KCd = KCd, Zd = Zd, run_time = run_time.ip, theta_delta = theta_delta.ip, lambda_delta = lambda_delta.ip, intermediates = intermediates.ip, control = list(max_iter = 100, tol = 1e-7))</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb6-31" data-line-number="31"><span class="co">#  out_it &lt;- semislv(theta = theta0, lambda = lambda0, Phi_fn = Phi_fn, Psi_fn = Psi_fn, method = &quot;iterative&quot;, diy = TRUE, Z = dat$Z, delta = dat$delta, KC = KC, n = n, KCd = KCd, Zd = Zd, run_time = run_time.it, theta_delta = theta_delta.it, lambda_delta = lambda_delta.it, intermediates = intermediates.it, control = list(max_iter = 100, tol = 1e-7))</span></a>
<a class="sourceLine" id="cb6-32" data-line-number="32">  </a>
<a class="sourceLine" id="cb6-33" data-line-number="33"><span class="co">#  mse_global &lt;- mse_global + sum((out_global$Model$x[1:p] - beta0)^2)</span></a>
<a class="sourceLine" id="cb6-34" data-line-number="34"><span class="co">#  mse_IP &lt;- mse_IP + sum((out_ip$theta - beta0)^2)</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"><span class="co">#  mse_IT &lt;- mse_IT + sum((out_it$theta - beta0)^2)</span></a>
<a class="sourceLine" id="cb6-36" data-line-number="36"><span class="co">#  time[i, ] &lt;- c(out_global$run.time, out_ip$run.time, out_it$run.time) # out_global$run.time,</span></a>
<a class="sourceLine" id="cb6-37" data-line-number="37"><span class="co">#  step[i, ] &lt;- c(out_global$Model$iter, out_ip$step, out_it$step) # out_global$Model$iter,</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38"><span class="co">#  compare[[i]] &lt;- rbind(out_global$Model$x[1:p], out_ip$theta, out_it$theta) # out_global$Model$x[1:p],</span></a>
<a class="sourceLine" id="cb6-39" data-line-number="39">  <span class="co">## cat(</span></a>
<a class="sourceLine" id="cb6-40" data-line-number="40">  <span class="co">##         &quot;step&quot;, i, sum(abs(out_global$Model$x[1:p] - out_ip$theta)),</span></a>
<a class="sourceLine" id="cb6-41" data-line-number="41">  <span class="co">##         sum(abs(out_global$Model$x[1:p] - out_it$theta)), &quot;\n&quot;</span></a>
<a class="sourceLine" id="cb6-42" data-line-number="42">  <span class="co">## )</span></a>
<a class="sourceLine" id="cb6-43" data-line-number="43"><span class="co">#  cat(&quot;iter&quot;, i, &quot;\n&quot;)</span></a>
<a class="sourceLine" id="cb6-44" data-line-number="44"><span class="co">#}</span></a>
<a class="sourceLine" id="cb6-45" data-line-number="45"><span class="co"># apply(time, 2, mean)</span></a>
<a class="sourceLine" id="cb6-46" data-line-number="46"><span class="co"># apply(step, 2, mean)</span></a>
<a class="sourceLine" id="cb6-47" data-line-number="47"><span class="co"># sqrt(mse_global &lt;- mse_global / nrep)</span></a>
<a class="sourceLine" id="cb6-48" data-line-number="48"><span class="co"># sqrt(mse_IP &lt;- mse_IP / nrep)</span></a>
<a class="sourceLine" id="cb6-49" data-line-number="49"><span class="co"># sqrt(mse_IT &lt;- mse_IT / nrep)</span></a></code></pre></div>
<p><span class="math inline">\(N = 1000\)</span></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># N &lt;- 1000</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co"># time2 &lt;- matrix(nrow = nrep, ncol = 3)</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co"># step2 &lt;- matrix(nrow = nrep, ncol = 3)</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co"># compare2 &lt;- list()</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co"># mse_global2 &lt;- 0</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co"># mse_IP2 &lt;- 0</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co"># mse_IT2 &lt;- 0</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co"># for (i in 1:nrep) {</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#   dat &lt;- sim.gen.STM(N, p, beta0, sigmaZ) ## don't change</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#   h &lt;- sd(dat$C) / (sum(dat$delta))^0.25</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#   KC &lt;- dnorm(as.matrix(dist(dat$C / h, diag = T, upper = T))) / h</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#   KCd &lt;- drop(KC %*% dat$delta)</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#   theta0 &lt;- rep(0, ncol(dat$Z))</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co">#   n &lt;- nrow(dat$Z)</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="co">#   Zd &lt;- drop(t(dat$Z) %*% dat$delta)</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#   lambda0 &lt;- rep(0, n)</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#   ## place my initial value</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="co">#   out_global &lt;- global(rep(0, N + p), f, dat$delta, dat$Z, KC, N, p)</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#   ## return beta, runtime, step</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">#   </span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="co">#   intermediates.ip &lt;- list(hC = lambda0, beta = theta0)</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="co">#   </span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="co">#   intermediates.it &lt;- list(hC = lambda0, beta = theta0)</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="co">#   out_ip &lt;- semislv(theta = theta0, lambda = lambda0, Phi_fn = Phi_fn, Psi_fn = Psi_fn, method = &quot;implicit&quot;, diy = TRUE, Z = dat$Z, delta = dat$delta, KC = KC, n = n, KCd = KCd, Zd = Zd, run_time = run_time.ip, theta_delta = theta_delta.ip, lambda_delta = lambda_delta.ip, intermediates = intermediates.ip, control = list(max_iter = 100, tol = 1e-7))</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25"><span class="co">#   out_it &lt;- semislv(theta = theta0, lambda = lambda0, Phi_fn = Phi_fn, Psi_fn = Psi_fn, method = &quot;iterative&quot;, diy = TRUE, Z = dat$Z, delta = dat$delta, KC = KC, n = n, KCd = KCd, Zd = Zd, run_time = run_time.it, theta_delta = theta_delta.it, lambda_delta = lambda_delta.it, intermediates = intermediates.it, control = list(max_iter = 100, tol = 1e-7))</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26"><span class="co">#   mse_global2 &lt;- mse_global2 + sum((out_global$Model$x[1:p] - beta0)^2)</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27"><span class="co">#   mse_IP2 &lt;- mse_IP2 + sum((out_ip$theta - beta0)^2)</span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28"><span class="co">#   mse_IT2 &lt;- mse_IT2 + sum((out_it$theta - beta0)^2)</span></a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="co">#   time2[i, ] &lt;- c(out_global$run.time, out_ip$run.time, out_it$run.time) # out_global$run.time,</span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30"><span class="co">#   step2[i, ] &lt;- c(out_global$Model$iter, out_ip$step, out_it$step) # out_global$Model$iter,</span></a>
<a class="sourceLine" id="cb7-31" data-line-number="31"><span class="co">#   compare2[[i]] &lt;- rbind(out_global$Model$x[1:p], out_ip$theta, out_it$theta) # out_global$Model$x[1:p],</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32">  <span class="co">## cat(</span></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">  <span class="co">##         &quot;step&quot;, i, sum(abs(out_global$Model$x[1:p] - out_ip$theta)),</span></a>
<a class="sourceLine" id="cb7-34" data-line-number="34">  <span class="co">##         sum(abs(out_global$Model$x[1:p] - out_it$theta)), &quot;\n&quot;</span></a>
<a class="sourceLine" id="cb7-35" data-line-number="35">  <span class="co">## )</span></a>
<a class="sourceLine" id="cb7-36" data-line-number="36"><span class="co">#   cat(&quot;iter&quot;, i, &quot;\n&quot;)</span></a>
<a class="sourceLine" id="cb7-37" data-line-number="37"><span class="co"># }</span></a>
<a class="sourceLine" id="cb7-38" data-line-number="38"><span class="co"># apply(time2, 2, mean)</span></a>
<a class="sourceLine" id="cb7-39" data-line-number="39"><span class="co"># apply(step2, 2, mean)</span></a>
<a class="sourceLine" id="cb7-40" data-line-number="40"><span class="co"># sqrt(mse_global2 &lt;- mse_global2 / nrep)</span></a>
<a class="sourceLine" id="cb7-41" data-line-number="41"><span class="co"># sqrt(mse_IP2 &lt;- mse_IP2 / nrep)</span></a>
<a class="sourceLine" id="cb7-42" data-line-number="42"><span class="co"># sqrt(mse_IT2 &lt;- mse_IT2 / nrep)</span></a></code></pre></div>
</div>
</div>
<div id="garch-m" class="section level1">
<h1>GARCH-M</h1>
<div id="code-2" class="section level2">
<h2>Code</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">library</span>(SemiEstimate)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw">library</span>(splines2)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw">library</span>(BB)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co"># ===========================</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co"># ====== Back Fitting =======</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co"># ===========================</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co"># sigma estimation</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">series_cal &lt;-<span class="st"> </span><span class="cf">function</span>(y, init, sigma_<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">  N &lt;-<span class="st"> </span><span class="kw">length</span>(y)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">  sigma &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> N)</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  sigma[<span class="dv">1</span>] &lt;-<span class="st"> </span>sigma_<span class="dv">1</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>N) {</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">    sigma[i] &lt;-<span class="st"> </span>init[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>init[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>y[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>init[<span class="dv">3</span>] <span class="op">*</span><span class="st"> </span>sigma[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">  <span class="kw">return</span>(sigma)</a>
<a class="sourceLine" id="cb8-18" data-line-number="18">}</a>
<a class="sourceLine" id="cb8-19" data-line-number="19"></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">spline_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(sigma, knots, n_partitions) {</a>
<a class="sourceLine" id="cb8-21" data-line-number="21">  m &lt;-<span class="st"> </span><span class="kw">cbind</span>(sigma, sigma<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-22" data-line-number="22">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_partitions) {</a>
<a class="sourceLine" id="cb8-23" data-line-number="23">    k &lt;-<span class="st"> </span>sigma <span class="op">-</span><span class="st"> </span>knots[i]</a>
<a class="sourceLine" id="cb8-24" data-line-number="24">    k[<span class="kw">which</span>(k <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb8-25" data-line-number="25">    m &lt;-<span class="st"> </span><span class="kw">cbind</span>(m, k<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-26" data-line-number="26">  }</a>
<a class="sourceLine" id="cb8-27" data-line-number="27">  <span class="kw">return</span>(m)</a>
<a class="sourceLine" id="cb8-28" data-line-number="28">}</a>
<a class="sourceLine" id="cb8-29" data-line-number="29"></a>
<a class="sourceLine" id="cb8-30" data-line-number="30"><span class="co"># QML</span></a>
<a class="sourceLine" id="cb8-31" data-line-number="31">M &lt;-<span class="st"> </span><span class="cf">function</span>(init_est, y, epsilon, sigma_<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb8-32" data-line-number="32">  sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init_est, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-33" data-line-number="33">  </a>
<a class="sourceLine" id="cb8-34" data-line-number="34">  k1 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(sigma))</a>
<a class="sourceLine" id="cb8-35" data-line-number="35">  k2 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(epsilon<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>sigma)</a>
<a class="sourceLine" id="cb8-36" data-line-number="36">  <span class="kw">return</span>(<span class="op">-</span>(k1 <span class="op">+</span><span class="st"> </span>k2))</a>
<a class="sourceLine" id="cb8-37" data-line-number="37">}</a>
<a class="sourceLine" id="cb8-38" data-line-number="38"></a>
<a class="sourceLine" id="cb8-39" data-line-number="39"><span class="co"># Backfitting</span></a>
<a class="sourceLine" id="cb8-40" data-line-number="40">bf &lt;-<span class="st"> </span><span class="cf">function</span>(y, <span class="dt">init =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb8-41" data-line-number="41">               <span class="dt">sigma_1 =</span> <span class="kw">var</span>(y), <span class="dt">tol =</span> <span class="fl">1e-5</span>, <span class="dt">maxiter =</span> <span class="dv">20</span>, <span class="dt">lower =</span> <span class="fl">1e-3</span>, <span class="dt">upper =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-42" data-line-number="42">               <span class="dt">judge_k =</span> F) {</a>
<a class="sourceLine" id="cb8-43" data-line-number="43">  key &lt;-<span class="st"> </span>init</a>
<a class="sourceLine" id="cb8-44" data-line-number="44">  t1 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb8-45" data-line-number="45">  iter &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb8-46" data-line-number="46">  step &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-47" data-line-number="47">  N &lt;-<span class="st"> </span><span class="kw">length</span>(y)</a>
<a class="sourceLine" id="cb8-48" data-line-number="48">  n_partitions &lt;-<span class="st"> </span><span class="kw">floor</span>(N<span class="op">^</span>(<span class="dv">3</span> <span class="op">/</span><span class="st"> </span><span class="dv">20</span>))</a>
<a class="sourceLine" id="cb8-49" data-line-number="49">  </a>
<a class="sourceLine" id="cb8-50" data-line-number="50">  judge &lt;-<span class="st"> </span><span class="ot">TRUE</span> </a>
<a class="sourceLine" id="cb8-51" data-line-number="51">  judge_covergence &lt;-<span class="st"> </span><span class="ot">TRUE</span> </a>
<a class="sourceLine" id="cb8-52" data-line-number="52">  </a>
<a class="sourceLine" id="cb8-53" data-line-number="53">  <span class="cf">while</span> (judge) {</a>
<a class="sourceLine" id="cb8-54" data-line-number="54">    sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-55" data-line-number="55">    </a>
<a class="sourceLine" id="cb8-56" data-line-number="56">    k &lt;-<span class="st"> </span><span class="kw">range</span>(sigma)</a>
<a class="sourceLine" id="cb8-57" data-line-number="57">    knots &lt;-<span class="st"> </span><span class="kw">seq</span>(k[<span class="dv">1</span>], k[<span class="dv">2</span>], <span class="dt">length.out =</span> n_partitions <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-58" data-line-number="58">    knots &lt;-<span class="st"> </span>knots[<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="kw">length</span>(knots))]</a>
<a class="sourceLine" id="cb8-59" data-line-number="59"></a>
<a class="sourceLine" id="cb8-60" data-line-number="60">    sigma_m &lt;-<span class="st"> </span><span class="kw">bSpline</span>(sigma, <span class="dt">knots =</span> knots, <span class="dt">degree =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-61" data-line-number="61">    eta_out &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>sigma_m)</a>
<a class="sourceLine" id="cb8-62" data-line-number="62">    eta &lt;-<span class="st"> </span><span class="kw">predict</span>(eta_out)</a>
<a class="sourceLine" id="cb8-63" data-line-number="63">    </a>
<a class="sourceLine" id="cb8-64" data-line-number="64">    epsilon &lt;-<span class="st"> </span>y <span class="op">-</span><span class="st"> </span>eta</a>
<a class="sourceLine" id="cb8-65" data-line-number="65">    </a>
<a class="sourceLine" id="cb8-66" data-line-number="66">    </a>
<a class="sourceLine" id="cb8-67" data-line-number="67">    init_out &lt;-<span class="st"> </span><span class="kw">BBoptim</span>(init, M,</a>
<a class="sourceLine" id="cb8-68" data-line-number="68">                        <span class="dt">y =</span> y, <span class="dt">sigma_1 =</span> sigma_<span class="dv">1</span>, <span class="dt">epsilon =</span> epsilon, <span class="dt">lower =</span> lower,</a>
<a class="sourceLine" id="cb8-69" data-line-number="69">                        <span class="dt">upper =</span> upper,</a>
<a class="sourceLine" id="cb8-70" data-line-number="70">                        <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">maxit =</span> <span class="dv">1500</span>, <span class="dt">gtol =</span> tol, <span class="dt">ftol =</span> tol<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-71" data-line-number="71">    )</a>
<a class="sourceLine" id="cb8-72" data-line-number="72">    </a>
<a class="sourceLine" id="cb8-73" data-line-number="73">    <span class="cf">if</span> (init_out<span class="op">$</span>convergence <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-74" data-line-number="74">    <span class="cf">if</span> (judge_k <span class="op">&amp;</span><span class="st"> </span>(init_out<span class="op">$</span>iter <span class="op">&gt;</span><span class="st"> </span><span class="dv">500</span>)) {</a>
<a class="sourceLine" id="cb8-75" data-line-number="75">      judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-76" data-line-number="76">    }</a>
<a class="sourceLine" id="cb8-77" data-line-number="77">    </a>
<a class="sourceLine" id="cb8-78" data-line-number="78">    </a>
<a class="sourceLine" id="cb8-79" data-line-number="79">    <span class="cf">if</span> (<span class="kw">max</span>(<span class="kw">abs</span>(init_out<span class="op">$</span>par <span class="op">-</span><span class="st"> </span>init)) <span class="op">&lt;</span><span class="st"> </span>tol) judge &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-80" data-line-number="80">    </a>
<a class="sourceLine" id="cb8-81" data-line-number="81">    <span class="kw">cat</span>(step, init <span class="op">-</span><span class="st"> </span>init_out<span class="op">$</span>par, init_out<span class="op">$</span>convergence, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb8-82" data-line-number="82"></a>
<a class="sourceLine" id="cb8-83" data-line-number="83">    init &lt;-<span class="st"> </span>init_out<span class="op">$</span>par</a>
<a class="sourceLine" id="cb8-84" data-line-number="84">    iter &lt;-<span class="st"> </span>iter <span class="op">+</span><span class="st"> </span>init_out<span class="op">$</span>iter</a>
<a class="sourceLine" id="cb8-85" data-line-number="85">    step &lt;-<span class="st"> </span>step <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-86" data-line-number="86">    <span class="cf">if</span> (step <span class="op">&gt;</span><span class="st"> </span>maxiter) judge &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-87" data-line-number="87">  }</a>
<a class="sourceLine" id="cb8-88" data-line-number="88">  <span class="cf">if</span> (step <span class="op">&gt;</span><span class="st"> </span>maxiter) judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-89" data-line-number="89">  sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-90" data-line-number="90">  run.time &lt;-<span class="st"> </span><span class="kw">Sys.time</span>() <span class="op">-</span><span class="st"> </span>t1</a>
<a class="sourceLine" id="cb8-91" data-line-number="91">  result &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb8-92" data-line-number="92">  result<span class="op">$</span>beta &lt;-<span class="st"> </span>init</a>
<a class="sourceLine" id="cb8-93" data-line-number="93">  result<span class="op">$</span>eta &lt;-<span class="st"> </span>eta</a>
<a class="sourceLine" id="cb8-94" data-line-number="94">  result<span class="op">$</span>sigma &lt;-<span class="st"> </span>sigma</a>
<a class="sourceLine" id="cb8-95" data-line-number="95">  result<span class="op">$</span>run.time &lt;-<span class="st"> </span>run.time</a>
<a class="sourceLine" id="cb8-96" data-line-number="96">  result<span class="op">$</span>step &lt;-<span class="st"> </span>step</a>
<a class="sourceLine" id="cb8-97" data-line-number="97">  result<span class="op">$</span>iter &lt;-<span class="st"> </span>iter</a>
<a class="sourceLine" id="cb8-98" data-line-number="98">  result<span class="op">$</span>judge_covergence &lt;-<span class="st"> </span>judge_covergence</a>
<a class="sourceLine" id="cb8-99" data-line-number="99">  </a>
<a class="sourceLine" id="cb8-100" data-line-number="100">  <span class="kw">return</span>(result)</a>
<a class="sourceLine" id="cb8-101" data-line-number="101">}</a>
<a class="sourceLine" id="cb8-102" data-line-number="102"></a>
<a class="sourceLine" id="cb8-103" data-line-number="103"><span class="co"># =================================</span></a>
<a class="sourceLine" id="cb8-104" data-line-number="104"><span class="co"># =========== SP-MBP ==============</span></a>
<a class="sourceLine" id="cb8-105" data-line-number="105"><span class="co"># =================================</span></a>
<a class="sourceLine" id="cb8-106" data-line-number="106"></a>
<a class="sourceLine" id="cb8-107" data-line-number="107"></a>
<a class="sourceLine" id="cb8-108" data-line-number="108">series_cal &lt;-<span class="st"> </span><span class="cf">function</span>(y, init, sigma_<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb8-109" data-line-number="109">  N &lt;-<span class="st"> </span><span class="kw">length</span>(y)</a>
<a class="sourceLine" id="cb8-110" data-line-number="110">  sigma &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> N)</a>
<a class="sourceLine" id="cb8-111" data-line-number="111">  sigma[<span class="dv">1</span>] &lt;-<span class="st"> </span>sigma_<span class="dv">1</span></a>
<a class="sourceLine" id="cb8-112" data-line-number="112">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>N) {</a>
<a class="sourceLine" id="cb8-113" data-line-number="113">    sigma[i] &lt;-<span class="st"> </span>init[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>init[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>y[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>init[<span class="dv">3</span>] <span class="op">*</span><span class="st"> </span>sigma[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb8-114" data-line-number="114">  }</a>
<a class="sourceLine" id="cb8-115" data-line-number="115">  <span class="kw">return</span>(sigma)</a>
<a class="sourceLine" id="cb8-116" data-line-number="116">}</a>
<a class="sourceLine" id="cb8-117" data-line-number="117"></a>
<a class="sourceLine" id="cb8-118" data-line-number="118"></a>
<a class="sourceLine" id="cb8-119" data-line-number="119">spline_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(sigma, knots, n_partitions) {</a>
<a class="sourceLine" id="cb8-120" data-line-number="120">  m &lt;-<span class="st"> </span><span class="kw">cbind</span>(sigma, sigma<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-121" data-line-number="121">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_partitions) {</a>
<a class="sourceLine" id="cb8-122" data-line-number="122">    k &lt;-<span class="st"> </span>sigma <span class="op">-</span><span class="st"> </span>knots[i]</a>
<a class="sourceLine" id="cb8-123" data-line-number="123">    k[<span class="kw">which</span>(k <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb8-124" data-line-number="124">    m &lt;-<span class="st"> </span><span class="kw">cbind</span>(m, k<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-125" data-line-number="125">  }</a>
<a class="sourceLine" id="cb8-126" data-line-number="126">  <span class="kw">return</span>(m)</a>
<a class="sourceLine" id="cb8-127" data-line-number="127">}</a>
<a class="sourceLine" id="cb8-128" data-line-number="128"></a>
<a class="sourceLine" id="cb8-129" data-line-number="129"></a>
<a class="sourceLine" id="cb8-130" data-line-number="130"><span class="co"># QML</span></a>
<a class="sourceLine" id="cb8-131" data-line-number="131">M_sp &lt;-<span class="st"> </span><span class="cf">function</span>(init_est, y, epsilon, sigma_<span class="dv">1</span>, Psi2, n_partitions) {</a>
<a class="sourceLine" id="cb8-132" data-line-number="132">  sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init_est, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-133" data-line-number="133">  k1 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(sigma))</a>
<a class="sourceLine" id="cb8-134" data-line-number="134">  k2 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(epsilon<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>sigma)</a>
<a class="sourceLine" id="cb8-135" data-line-number="135">  </a>
<a class="sourceLine" id="cb8-136" data-line-number="136">  k &lt;-<span class="st"> </span><span class="kw">range</span>(sigma)</a>
<a class="sourceLine" id="cb8-137" data-line-number="137">  knots &lt;-<span class="st"> </span><span class="kw">seq</span>(k[<span class="dv">1</span>], k[<span class="dv">2</span>], <span class="dt">length.out =</span> n_partitions <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-138" data-line-number="138">  knots &lt;-<span class="st"> </span>knots[<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="kw">length</span>(knots))]</a>
<a class="sourceLine" id="cb8-139" data-line-number="139">  sigma_m &lt;-<span class="st"> </span><span class="kw">bSpline</span>(sigma, <span class="dt">knots =</span> knots, <span class="dt">degree =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-140" data-line-number="140">  </a>
<a class="sourceLine" id="cb8-141" data-line-number="141">  eta_out &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>sigma_m)</a>
<a class="sourceLine" id="cb8-142" data-line-number="142">  eta &lt;-<span class="st"> </span><span class="kw">predict</span>(eta_out)</a>
<a class="sourceLine" id="cb8-143" data-line-number="143">  </a>
<a class="sourceLine" id="cb8-144" data-line-number="144">  k3 &lt;-<span class="st"> </span>Psi2 <span class="op">%*%</span><span class="st"> </span>init_est</a>
<a class="sourceLine" id="cb8-145" data-line-number="145">  </a>
<a class="sourceLine" id="cb8-146" data-line-number="146">  <span class="kw">return</span>(<span class="op">-</span>(k1 <span class="op">+</span><span class="st"> </span>k2 <span class="op">+</span><span class="st"> </span>k3))</a>
<a class="sourceLine" id="cb8-147" data-line-number="147">}</a>
<a class="sourceLine" id="cb8-148" data-line-number="148"></a>
<a class="sourceLine" id="cb8-149" data-line-number="149"><span class="co"># Psi_2</span></a>
<a class="sourceLine" id="cb8-150" data-line-number="150">Psi_<span class="dv">2</span>_B &lt;-<span class="st"> </span><span class="cf">function</span>(y, init, sigma, epsilon, knots) {</a>
<a class="sourceLine" id="cb8-151" data-line-number="151">  init_dsigma &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb8-152" data-line-number="152">  dsigma &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="kw">length</span>(y), <span class="dt">ncol =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb8-153" data-line-number="153">  dsigma[<span class="dv">1</span>, ] &lt;-<span class="st"> </span>init_dsigma</a>
<a class="sourceLine" id="cb8-154" data-line-number="154">  </a>
<a class="sourceLine" id="cb8-155" data-line-number="155">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw">length</span>(sigma)) {</a>
<a class="sourceLine" id="cb8-156" data-line-number="156">    dsigma[i, ] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, y[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]<span class="op">^</span><span class="dv">2</span>, sigma[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]) <span class="op">+</span><span class="st"> </span>init[<span class="dv">3</span>] <span class="op">*</span><span class="st"> </span>dsigma[(i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>), ]</a>
<a class="sourceLine" id="cb8-157" data-line-number="157">  }</a>
<a class="sourceLine" id="cb8-158" data-line-number="158">  </a>
<a class="sourceLine" id="cb8-159" data-line-number="159">  sigma_d &lt;-<span class="st"> </span><span class="kw">dbs</span>(sigma, <span class="dt">knots =</span> knots, <span class="dt">degree =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-160" data-line-number="160">  eta_d &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>sigma_d)</a>
<a class="sourceLine" id="cb8-161" data-line-number="161">  eta_d &lt;-<span class="st"> </span><span class="kw">predict</span>(eta_d)</a>
<a class="sourceLine" id="cb8-162" data-line-number="162">  eta_d &lt;-<span class="st"> </span>eta_d <span class="op">*</span><span class="st"> </span>dsigma</a>
<a class="sourceLine" id="cb8-163" data-line-number="163">  </a>
<a class="sourceLine" id="cb8-164" data-line-number="164">  output &lt;-<span class="st"> </span><span class="kw">apply</span>(epsilon <span class="op">/</span><span class="st"> </span>sigma <span class="op">*</span><span class="st"> </span>eta_d, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb8-165" data-line-number="165">  </a>
<a class="sourceLine" id="cb8-166" data-line-number="166">  <span class="kw">return</span>(output)</a>
<a class="sourceLine" id="cb8-167" data-line-number="167">}</a>
<a class="sourceLine" id="cb8-168" data-line-number="168"></a>
<a class="sourceLine" id="cb8-169" data-line-number="169"><span class="co"># SPMBP</span></a>
<a class="sourceLine" id="cb8-170" data-line-number="170">spmbp_B &lt;-<span class="st"> </span><span class="cf">function</span>(y, <span class="dt">init =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb8-171" data-line-number="171">                    <span class="dt">sigma_1 =</span> <span class="kw">var</span>(y), <span class="dt">tol =</span> <span class="fl">1e-5</span>, <span class="dt">maxiter =</span> <span class="dv">20</span>, <span class="dt">lower =</span> <span class="fl">1e-3</span>, <span class="dt">upper =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-172" data-line-number="172">                    <span class="dt">judge_k =</span> F) {</a>
<a class="sourceLine" id="cb8-173" data-line-number="173">  key &lt;-<span class="st"> </span>init</a>
<a class="sourceLine" id="cb8-174" data-line-number="174">  t1 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb8-175" data-line-number="175">  iter &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb8-176" data-line-number="176">  step &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-177" data-line-number="177">  N &lt;-<span class="st"> </span><span class="kw">length</span>(y)</a>
<a class="sourceLine" id="cb8-178" data-line-number="178">  n_partitions &lt;-<span class="st"> </span><span class="kw">floor</span>(N<span class="op">^</span>(<span class="dv">3</span> <span class="op">/</span><span class="st"> </span><span class="dv">20</span>))</a>
<a class="sourceLine" id="cb8-179" data-line-number="179">  </a>
<a class="sourceLine" id="cb8-180" data-line-number="180">  judge &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb8-181" data-line-number="181">  judge_covergence &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb8-182" data-line-number="182">  </a>
<a class="sourceLine" id="cb8-183" data-line-number="183">  <span class="cf">while</span> (judge) {</a>
<a class="sourceLine" id="cb8-184" data-line-number="184">    sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-185" data-line-number="185">    </a>
<a class="sourceLine" id="cb8-186" data-line-number="186">    </a>
<a class="sourceLine" id="cb8-187" data-line-number="187">    k &lt;-<span class="st"> </span><span class="kw">range</span>(sigma)</a>
<a class="sourceLine" id="cb8-188" data-line-number="188">    knots &lt;-<span class="st"> </span><span class="kw">seq</span>(k[<span class="dv">1</span>], k[<span class="dv">2</span>], <span class="dt">length.out =</span> n_partitions <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-189" data-line-number="189">    knots &lt;-<span class="st"> </span>knots[<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="kw">length</span>(knots))]</a>
<a class="sourceLine" id="cb8-190" data-line-number="190">    sigma_m &lt;-<span class="st"> </span><span class="kw">bSpline</span>(sigma, <span class="dt">knots =</span> knots, <span class="dt">degree =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-191" data-line-number="191">    </a>
<a class="sourceLine" id="cb8-192" data-line-number="192">    eta_out &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>sigma_m)</a>
<a class="sourceLine" id="cb8-193" data-line-number="193">    eta &lt;-<span class="st"> </span><span class="kw">predict</span>(eta_out)</a>
<a class="sourceLine" id="cb8-194" data-line-number="194">    </a>
<a class="sourceLine" id="cb8-195" data-line-number="195">    epsilon &lt;-<span class="st"> </span>y <span class="op">-</span><span class="st"> </span>eta</a>
<a class="sourceLine" id="cb8-196" data-line-number="196"></a>
<a class="sourceLine" id="cb8-197" data-line-number="197">    Psi2 &lt;-<span class="st"> </span><span class="kw">Psi_2_B</span>(y, init, sigma, epsilon, knots)</a>
<a class="sourceLine" id="cb8-198" data-line-number="198">    </a>
<a class="sourceLine" id="cb8-199" data-line-number="199">    init_out &lt;-<span class="st"> </span><span class="kw">BBoptim</span>(init, M_sp,</a>
<a class="sourceLine" id="cb8-200" data-line-number="200">                        <span class="dt">y =</span> y, <span class="dt">sigma_1 =</span> sigma_<span class="dv">1</span>, <span class="dt">epsilon =</span> epsilon,</a>
<a class="sourceLine" id="cb8-201" data-line-number="201">                        <span class="dt">n_partitions =</span> n_partitions,</a>
<a class="sourceLine" id="cb8-202" data-line-number="202">                        <span class="dt">Psi2 =</span> Psi2, <span class="dt">lower =</span> <span class="fl">1e-3</span>, <span class="dt">upper =</span> upper,</a>
<a class="sourceLine" id="cb8-203" data-line-number="203">                        <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">maxit =</span> <span class="dv">1500</span>, <span class="dt">gtol =</span> tol, <span class="dt">ftol =</span> tol<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-204" data-line-number="204">    )</a>
<a class="sourceLine" id="cb8-205" data-line-number="205">    </a>
<a class="sourceLine" id="cb8-206" data-line-number="206">    <span class="cf">if</span> (init_out<span class="op">$</span>convergence <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-207" data-line-number="207">    <span class="cf">if</span> (judge_k <span class="op">&amp;</span><span class="st"> </span>(init_out<span class="op">$</span>iter <span class="op">&gt;</span><span class="st"> </span><span class="dv">500</span>)) {</a>
<a class="sourceLine" id="cb8-208" data-line-number="208">      judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-209" data-line-number="209">    }</a>
<a class="sourceLine" id="cb8-210" data-line-number="210">    </a>
<a class="sourceLine" id="cb8-211" data-line-number="211">    <span class="cf">if</span> (<span class="kw">max</span>(<span class="kw">abs</span>(init_out<span class="op">$</span>par <span class="op">-</span><span class="st"> </span>init)) <span class="op">&lt;</span><span class="st"> </span>tol) judge &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-212" data-line-number="212">    </a>
<a class="sourceLine" id="cb8-213" data-line-number="213">    <span class="kw">cat</span>(step, init <span class="op">-</span><span class="st"> </span>init_out<span class="op">$</span>par, init_out<span class="op">$</span>convergence, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb8-214" data-line-number="214">    init &lt;-<span class="st"> </span>init_out<span class="op">$</span>par</a>
<a class="sourceLine" id="cb8-215" data-line-number="215">    </a>
<a class="sourceLine" id="cb8-216" data-line-number="216">    step &lt;-<span class="st"> </span>step <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-217" data-line-number="217">    iter &lt;-<span class="st"> </span>iter <span class="op">+</span><span class="st"> </span>init_out<span class="op">$</span>iter</a>
<a class="sourceLine" id="cb8-218" data-line-number="218">    <span class="cf">if</span> (step <span class="op">&gt;</span><span class="st"> </span>maxiter) judge &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-219" data-line-number="219">  }</a>
<a class="sourceLine" id="cb8-220" data-line-number="220">  <span class="cf">if</span> (step <span class="op">&gt;</span><span class="st"> </span>maxiter) judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-221" data-line-number="221">  </a>
<a class="sourceLine" id="cb8-222" data-line-number="222">  sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-223" data-line-number="223">  run.time &lt;-<span class="st"> </span><span class="kw">Sys.time</span>() <span class="op">-</span><span class="st"> </span>t1</a>
<a class="sourceLine" id="cb8-224" data-line-number="224">  result &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb8-225" data-line-number="225">  result<span class="op">$</span>beta &lt;-<span class="st"> </span>init</a>
<a class="sourceLine" id="cb8-226" data-line-number="226">  result<span class="op">$</span>eta &lt;-<span class="st"> </span>eta</a>
<a class="sourceLine" id="cb8-227" data-line-number="227">  result<span class="op">$</span>sigma &lt;-<span class="st"> </span>sigma</a>
<a class="sourceLine" id="cb8-228" data-line-number="228">  result<span class="op">$</span>run.time &lt;-<span class="st"> </span>run.time</a>
<a class="sourceLine" id="cb8-229" data-line-number="229">  result<span class="op">$</span>step &lt;-<span class="st"> </span>step</a>
<a class="sourceLine" id="cb8-230" data-line-number="230">  result<span class="op">$</span>iter &lt;-<span class="st"> </span>iter</a>
<a class="sourceLine" id="cb8-231" data-line-number="231">  result<span class="op">$</span>judge_covergence &lt;-<span class="st"> </span>judge_covergence</a>
<a class="sourceLine" id="cb8-232" data-line-number="232">  </a>
<a class="sourceLine" id="cb8-233" data-line-number="233">  <span class="kw">return</span>(result)</a>
<a class="sourceLine" id="cb8-234" data-line-number="234">}</a>
<a class="sourceLine" id="cb8-235" data-line-number="235"></a>
<a class="sourceLine" id="cb8-236" data-line-number="236"></a>
<a class="sourceLine" id="cb8-237" data-line-number="237"><span class="co"># ===========================</span></a>
<a class="sourceLine" id="cb8-238" data-line-number="238"><span class="co"># ====== IP-GARCH ===========</span></a>
<a class="sourceLine" id="cb8-239" data-line-number="239"><span class="co"># ===========================</span></a>
<a class="sourceLine" id="cb8-240" data-line-number="240"></a>
<a class="sourceLine" id="cb8-241" data-line-number="241"><span class="co"># QML</span></a>
<a class="sourceLine" id="cb8-242" data-line-number="242">M_ip_BB &lt;-<span class="st"> </span><span class="cf">function</span>(init_est, y, sigma_<span class="dv">1</span>, n_partitions) {</a>
<a class="sourceLine" id="cb8-243" data-line-number="243">  sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init_est, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-244" data-line-number="244">  k &lt;-<span class="st"> </span><span class="kw">range</span>(sigma)</a>
<a class="sourceLine" id="cb8-245" data-line-number="245">  knots &lt;-<span class="st"> </span><span class="kw">seq</span>(k[<span class="dv">1</span>], k[<span class="dv">2</span>], <span class="dt">length.out =</span> n_partitions <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-246" data-line-number="246">  knots &lt;-<span class="st"> </span>knots[<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="kw">length</span>(knots))]</a>
<a class="sourceLine" id="cb8-247" data-line-number="247">  sigma_m &lt;-<span class="st"> </span><span class="kw">bSpline</span>(sigma, <span class="dt">knots =</span> knots, <span class="dt">degree =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-248" data-line-number="248">  </a>
<a class="sourceLine" id="cb8-249" data-line-number="249">  eta_out &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>sigma_m)</a>
<a class="sourceLine" id="cb8-250" data-line-number="250">  eta &lt;-<span class="st"> </span><span class="kw">predict</span>(eta_out)</a>
<a class="sourceLine" id="cb8-251" data-line-number="251">  </a>
<a class="sourceLine" id="cb8-252" data-line-number="252">  epsilon &lt;-<span class="st"> </span>y <span class="op">-</span><span class="st"> </span>eta</a>
<a class="sourceLine" id="cb8-253" data-line-number="253">  </a>
<a class="sourceLine" id="cb8-254" data-line-number="254">  k1 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(sigma))</a>
<a class="sourceLine" id="cb8-255" data-line-number="255">  k2 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(epsilon<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>sigma)</a>
<a class="sourceLine" id="cb8-256" data-line-number="256">  </a>
<a class="sourceLine" id="cb8-257" data-line-number="257">  <span class="kw">return</span>(<span class="op">-</span>(k1 <span class="op">+</span><span class="st"> </span>k2))</a>
<a class="sourceLine" id="cb8-258" data-line-number="258">}</a>
<a class="sourceLine" id="cb8-259" data-line-number="259"></a>
<a class="sourceLine" id="cb8-260" data-line-number="260">IP_GARCH_BB &lt;-<span class="st"> </span><span class="cf">function</span>(y, <span class="dt">init =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb8-261" data-line-number="261">                        <span class="dt">sigma_1 =</span> <span class="kw">var</span>(y), <span class="dt">tol =</span> <span class="fl">1e-5</span>, <span class="dt">maxiter =</span> <span class="dv">20</span>, <span class="dt">lower =</span> <span class="fl">1e-3</span>, <span class="dt">upper =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-262" data-line-number="262">                        <span class="dt">judge_k =</span> F) {</a>
<a class="sourceLine" id="cb8-263" data-line-number="263">  key &lt;-<span class="st"> </span>init</a>
<a class="sourceLine" id="cb8-264" data-line-number="264">  t1 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb8-265" data-line-number="265">  iter &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb8-266" data-line-number="266">  step &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-267" data-line-number="267">  N &lt;-<span class="st"> </span><span class="kw">length</span>(y)</a>
<a class="sourceLine" id="cb8-268" data-line-number="268">  n_partitions &lt;-<span class="st"> </span><span class="kw">floor</span>(N<span class="op">^</span>(<span class="dv">3</span> <span class="op">/</span><span class="st"> </span><span class="dv">20</span>))</a>
<a class="sourceLine" id="cb8-269" data-line-number="269">  </a>
<a class="sourceLine" id="cb8-270" data-line-number="270">  judge &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb8-271" data-line-number="271">  judge_covergence &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb8-272" data-line-number="272"></a>
<a class="sourceLine" id="cb8-273" data-line-number="273">  init_out &lt;-<span class="st"> </span><span class="kw">BBoptim</span>(init, M_ip_BB,</a>
<a class="sourceLine" id="cb8-274" data-line-number="274">                      <span class="dt">y =</span> y, <span class="dt">sigma_1 =</span> sigma_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-275" data-line-number="275">                      <span class="dt">n_partitions =</span> n_partitions, <span class="dt">lower =</span> <span class="fl">1e-3</span>, <span class="dt">upper =</span> upper,</a>
<a class="sourceLine" id="cb8-276" data-line-number="276">                      <span class="dt">control =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb8-277" data-line-number="277">                        <span class="dt">maxit =</span> <span class="dv">1500</span>, <span class="dt">ftol =</span> tol<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb8-278" data-line-number="278">                        <span class="dt">gtol =</span> tol</a>
<a class="sourceLine" id="cb8-279" data-line-number="279">                      )</a>
<a class="sourceLine" id="cb8-280" data-line-number="280">  )</a>
<a class="sourceLine" id="cb8-281" data-line-number="281">  </a>
<a class="sourceLine" id="cb8-282" data-line-number="282">  </a>
<a class="sourceLine" id="cb8-283" data-line-number="283">  </a>
<a class="sourceLine" id="cb8-284" data-line-number="284">  <span class="cf">if</span> (init_out<span class="op">$</span>convergence <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-285" data-line-number="285">  <span class="cf">if</span> (judge_k <span class="op">&amp;</span><span class="st"> </span>init_out<span class="op">$</span>iter <span class="op">&gt;</span><span class="st"> </span><span class="dv">500</span>) {</a>
<a class="sourceLine" id="cb8-286" data-line-number="286">    judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-287" data-line-number="287">  }</a>
<a class="sourceLine" id="cb8-288" data-line-number="288">  </a>
<a class="sourceLine" id="cb8-289" data-line-number="289">  <span class="cf">if</span> (<span class="kw">sum</span>((init_out<span class="op">$</span>par <span class="op">-</span><span class="st"> </span>init)<span class="op">^</span><span class="dv">2</span>) <span class="op">&lt;</span><span class="st"> </span>tol) judge &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-290" data-line-number="290">  </a>
<a class="sourceLine" id="cb8-291" data-line-number="291">  <span class="kw">cat</span>(step, init <span class="op">-</span><span class="st"> </span>init_out<span class="op">$</span>par, init_out<span class="op">$</span>convergence, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb8-292" data-line-number="292">  init &lt;-<span class="st"> </span>init_out<span class="op">$</span>par</a>
<a class="sourceLine" id="cb8-293" data-line-number="293">  </a>
<a class="sourceLine" id="cb8-294" data-line-number="294">  step &lt;-<span class="st"> </span>step <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-295" data-line-number="295">  iter &lt;-<span class="st"> </span>iter <span class="op">+</span><span class="st"> </span>init_out<span class="op">$</span>iter</a>
<a class="sourceLine" id="cb8-296" data-line-number="296">  <span class="cf">if</span> (step <span class="op">&gt;</span><span class="st"> </span>maxiter) judge &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-297" data-line-number="297">  </a>
<a class="sourceLine" id="cb8-298" data-line-number="298">  <span class="cf">if</span> (step <span class="op">&gt;</span><span class="st"> </span>maxiter) judge_covergence &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-299" data-line-number="299">  </a>
<a class="sourceLine" id="cb8-300" data-line-number="300">  sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-301" data-line-number="301">  run.time &lt;-<span class="st"> </span><span class="kw">Sys.time</span>() <span class="op">-</span><span class="st"> </span>t1</a>
<a class="sourceLine" id="cb8-302" data-line-number="302">  result &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb8-303" data-line-number="303">  result<span class="op">$</span>beta &lt;-<span class="st"> </span>init</a>
<a class="sourceLine" id="cb8-304" data-line-number="304">  <span class="co"># result$eta = eta</span></a>
<a class="sourceLine" id="cb8-305" data-line-number="305">  result<span class="op">$</span>sigma &lt;-<span class="st"> </span>sigma</a>
<a class="sourceLine" id="cb8-306" data-line-number="306">  result<span class="op">$</span>run.time &lt;-<span class="st"> </span>run.time</a>
<a class="sourceLine" id="cb8-307" data-line-number="307">  result<span class="op">$</span>step &lt;-<span class="st"> </span>step</a>
<a class="sourceLine" id="cb8-308" data-line-number="308">  result<span class="op">$</span>iter &lt;-<span class="st"> </span>iter</a>
<a class="sourceLine" id="cb8-309" data-line-number="309">  result<span class="op">$</span>judge_covergence &lt;-<span class="st"> </span>judge_covergence</a>
<a class="sourceLine" id="cb8-310" data-line-number="310">  </a>
<a class="sourceLine" id="cb8-311" data-line-number="311">  <span class="kw">return</span>(result)</a>
<a class="sourceLine" id="cb8-312" data-line-number="312">}</a>
<a class="sourceLine" id="cb8-313" data-line-number="313"></a>
<a class="sourceLine" id="cb8-314" data-line-number="314"></a>
<a class="sourceLine" id="cb8-315" data-line-number="315"></a>
<a class="sourceLine" id="cb8-316" data-line-number="316">IP_GARCH_BB &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates, data, theta) {</a>
<a class="sourceLine" id="cb8-317" data-line-number="317">  tol &lt;-<span class="st"> </span><span class="fl">1e-5</span></a>
<a class="sourceLine" id="cb8-318" data-line-number="318">  y &lt;-<span class="st"> </span>data</a>
<a class="sourceLine" id="cb8-319" data-line-number="319">  init &lt;-<span class="st"> </span>theta</a>
<a class="sourceLine" id="cb8-320" data-line-number="320">  sigma_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">var</span>(y)</a>
<a class="sourceLine" id="cb8-321" data-line-number="321">  upper &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-322" data-line-number="322">  intermediates<span class="op">$</span>theta_<span class="dv">1</span> &lt;-<span class="st"> </span>init</a>
<a class="sourceLine" id="cb8-323" data-line-number="323">  <span class="co"># estimate sigma</span></a>
<a class="sourceLine" id="cb8-324" data-line-number="324">  series_cal &lt;-<span class="st"> </span><span class="cf">function</span>(y, init, sigma_<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb8-325" data-line-number="325">    N &lt;-<span class="st"> </span><span class="kw">length</span>(y)</a>
<a class="sourceLine" id="cb8-326" data-line-number="326">    sigma &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> N)</a>
<a class="sourceLine" id="cb8-327" data-line-number="327">    sigma[<span class="dv">1</span>] &lt;-<span class="st"> </span>sigma_<span class="dv">1</span></a>
<a class="sourceLine" id="cb8-328" data-line-number="328">    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>N) {</a>
<a class="sourceLine" id="cb8-329" data-line-number="329">      sigma[i] &lt;-<span class="st"> </span>init[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>init[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>y[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>init[<span class="dv">3</span>] <span class="op">*</span><span class="st"> </span>sigma[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb8-330" data-line-number="330">    }</a>
<a class="sourceLine" id="cb8-331" data-line-number="331">    <span class="kw">return</span>(sigma)</a>
<a class="sourceLine" id="cb8-332" data-line-number="332">  }</a>
<a class="sourceLine" id="cb8-333" data-line-number="333">  </a>
<a class="sourceLine" id="cb8-334" data-line-number="334">  <span class="co"># calc the spline matric</span></a>
<a class="sourceLine" id="cb8-335" data-line-number="335">  spline_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(sigma, knots, n_partitions) {</a>
<a class="sourceLine" id="cb8-336" data-line-number="336">    m &lt;-<span class="st"> </span><span class="kw">cbind</span>(sigma, sigma<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-337" data-line-number="337">    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n_partitions) {</a>
<a class="sourceLine" id="cb8-338" data-line-number="338">      k &lt;-<span class="st"> </span>sigma <span class="op">-</span><span class="st"> </span>knots[i]</a>
<a class="sourceLine" id="cb8-339" data-line-number="339">      k[<span class="kw">which</span>(k <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb8-340" data-line-number="340">      m &lt;-<span class="st"> </span><span class="kw">cbind</span>(m, k<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-341" data-line-number="341">    }</a>
<a class="sourceLine" id="cb8-342" data-line-number="342">    <span class="kw">return</span>(m)</a>
<a class="sourceLine" id="cb8-343" data-line-number="343">  }</a>
<a class="sourceLine" id="cb8-344" data-line-number="344">  </a>
<a class="sourceLine" id="cb8-345" data-line-number="345">  <span class="co"># Calculate the Psi</span></a>
<a class="sourceLine" id="cb8-346" data-line-number="346">  M &lt;-<span class="st"> </span><span class="cf">function</span>(init_est, y, epsilon, sigma_<span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb8-347" data-line-number="347">    sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init_est, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-348" data-line-number="348">    k1 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(sigma))</a>
<a class="sourceLine" id="cb8-349" data-line-number="349">    k2 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(epsilon<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>sigma)</a>
<a class="sourceLine" id="cb8-350" data-line-number="350">    <span class="kw">return</span>(<span class="op">-</span>(k1 <span class="op">+</span><span class="st"> </span>k2))</a>
<a class="sourceLine" id="cb8-351" data-line-number="351">  }</a>
<a class="sourceLine" id="cb8-352" data-line-number="352">  </a>
<a class="sourceLine" id="cb8-353" data-line-number="353">  M_ip_BB &lt;-<span class="st"> </span><span class="cf">function</span>(init_est, y, sigma_<span class="dv">1</span>, n_partitions) {</a>
<a class="sourceLine" id="cb8-354" data-line-number="354">    sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init_est, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-355" data-line-number="355">    k &lt;-<span class="st"> </span><span class="kw">range</span>(sigma)</a>
<a class="sourceLine" id="cb8-356" data-line-number="356">    knots &lt;-<span class="st"> </span><span class="kw">seq</span>(k[<span class="dv">1</span>], k[<span class="dv">2</span>], <span class="dt">length.out =</span> n_partitions <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-357" data-line-number="357">    knots &lt;-<span class="st"> </span>knots[<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="kw">length</span>(knots))]</a>
<a class="sourceLine" id="cb8-358" data-line-number="358">    sigma_m &lt;-<span class="st"> </span><span class="kw">bSpline</span>(sigma, <span class="dt">knots =</span> knots, <span class="dt">degree =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-359" data-line-number="359">    </a>
<a class="sourceLine" id="cb8-360" data-line-number="360">    eta_out &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>sigma_m)</a>
<a class="sourceLine" id="cb8-361" data-line-number="361">    eta &lt;-<span class="st"> </span><span class="kw">predict</span>(eta_out)</a>
<a class="sourceLine" id="cb8-362" data-line-number="362">    </a>
<a class="sourceLine" id="cb8-363" data-line-number="363">    epsilon &lt;-<span class="st"> </span>y <span class="op">-</span><span class="st"> </span>eta</a>
<a class="sourceLine" id="cb8-364" data-line-number="364">    </a>
<a class="sourceLine" id="cb8-365" data-line-number="365">    k1 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(sigma))</a>
<a class="sourceLine" id="cb8-366" data-line-number="366">    k2 &lt;-<span class="st"> </span><span class="dv">-1</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sum</span>(epsilon<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>sigma)</a>
<a class="sourceLine" id="cb8-367" data-line-number="367">    </a>
<a class="sourceLine" id="cb8-368" data-line-number="368">    <span class="kw">return</span>(<span class="op">-</span>(k1 <span class="op">+</span><span class="st"> </span>k2))</a>
<a class="sourceLine" id="cb8-369" data-line-number="369">  }</a>
<a class="sourceLine" id="cb8-370" data-line-number="370">  N &lt;-<span class="st"> </span><span class="kw">length</span>(y)</a>
<a class="sourceLine" id="cb8-371" data-line-number="371">  n_partitions &lt;-<span class="st"> </span><span class="kw">floor</span>(N<span class="op">^</span>(<span class="dv">3</span> <span class="op">/</span><span class="st"> </span><span class="dv">20</span>))</a>
<a class="sourceLine" id="cb8-372" data-line-number="372">  <span class="kw">print</span>(<span class="st">&quot;---init----&quot;</span>)</a>
<a class="sourceLine" id="cb8-373" data-line-number="373">  <span class="kw">print</span>(init)</a>
<a class="sourceLine" id="cb8-374" data-line-number="374">  </a>
<a class="sourceLine" id="cb8-375" data-line-number="375">  init_out &lt;-<span class="st"> </span><span class="kw">BBoptim</span>(init, M_ip_BB,</a>
<a class="sourceLine" id="cb8-376" data-line-number="376">                          <span class="dt">y =</span> y, <span class="dt">sigma_1 =</span> sigma_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-377" data-line-number="377">                          <span class="dt">n_partitions =</span> n_partitions, <span class="dt">lower =</span> <span class="fl">1e-3</span>, <span class="dt">upper =</span> upper,</a>
<a class="sourceLine" id="cb8-378" data-line-number="378">                          <span class="dt">control =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb8-379" data-line-number="379">                            <span class="dt">maxit =</span> <span class="dv">1500</span>, <span class="dt">ftol =</span> tol<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb8-380" data-line-number="380">                            <span class="dt">gtol =</span> tol</a>
<a class="sourceLine" id="cb8-381" data-line-number="381">                          )</a>
<a class="sourceLine" id="cb8-382" data-line-number="382">  )</a>
<a class="sourceLine" id="cb8-383" data-line-number="383">  </a>
<a class="sourceLine" id="cb8-384" data-line-number="384">  intermediates<span class="op">$</span>theta &lt;-<span class="st"> </span>init_out<span class="op">$</span>par</a>
<a class="sourceLine" id="cb8-385" data-line-number="385">  </a>
<a class="sourceLine" id="cb8-386" data-line-number="386">  sigma &lt;-<span class="st"> </span><span class="kw">series_cal</span>(y, init, sigma_<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-387" data-line-number="387">  intermediates<span class="op">$</span>sigma_delta &lt;-<span class="st"> </span>sigma <span class="op">-</span><span class="st"> </span>intermediates<span class="op">$</span>sigma</a>
<a class="sourceLine" id="cb8-388" data-line-number="388">  </a>
<a class="sourceLine" id="cb8-389" data-line-number="389">  intermediates<span class="op">$</span>iter &lt;-<span class="st"> </span>init_out<span class="op">$</span>iter</a>
<a class="sourceLine" id="cb8-390" data-line-number="390">  intermediates</a>
<a class="sourceLine" id="cb8-391" data-line-number="391">}</a>
<a class="sourceLine" id="cb8-392" data-line-number="392"></a>
<a class="sourceLine" id="cb8-393" data-line-number="393">get_result_from_raw &lt;-<span class="st"> </span><span class="cf">function</span>(raw_fit) {</a>
<a class="sourceLine" id="cb8-394" data-line-number="394">  result &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb8-395" data-line-number="395">  result<span class="op">$</span>beta &lt;-<span class="st"> </span>raw_fit<span class="op">$</span>theta</a>
<a class="sourceLine" id="cb8-396" data-line-number="396">  result<span class="op">$</span>sigma &lt;-<span class="st"> </span>raw_fit<span class="op">$</span>parameters<span class="op">$</span>lambda</a>
<a class="sourceLine" id="cb8-397" data-line-number="397">  result<span class="op">$</span>run.time &lt;-<span class="st"> </span>raw_fit<span class="op">$</span>run.time</a>
<a class="sourceLine" id="cb8-398" data-line-number="398">  result<span class="op">$</span>iter &lt;-<span class="st"> </span>ip_raw<span class="op">$</span>iterspace<span class="op">$</span>jac_like<span class="op">$</span>intermediates<span class="op">$</span>iter</a>
<a class="sourceLine" id="cb8-399" data-line-number="399">  result<span class="op">$</span>judge_covergence &lt;-<span class="st"> </span>result<span class="op">$</span>iter <span class="op">&lt;</span><span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb8-400" data-line-number="400">  result</a>
<a class="sourceLine" id="cb8-401" data-line-number="401">}</a>
<a class="sourceLine" id="cb8-402" data-line-number="402"></a>
<a class="sourceLine" id="cb8-403" data-line-number="403">theta_delta &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates) {</a>
<a class="sourceLine" id="cb8-404" data-line-number="404">  intermediates<span class="op">$</span>theta_delta &lt;-<span class="st"> </span>intermediates<span class="op">$</span>theta <span class="op">-</span><span class="st"> </span>intermediates<span class="op">$</span>theta_<span class="dv">1</span></a>
<a class="sourceLine" id="cb8-405" data-line-number="405">  intermediates</a>
<a class="sourceLine" id="cb8-406" data-line-number="406">}</a>
<a class="sourceLine" id="cb8-407" data-line-number="407"></a>
<a class="sourceLine" id="cb8-408" data-line-number="408">lambda_delta &lt;-<span class="st"> </span><span class="cf">function</span>(intermediates) {</a>
<a class="sourceLine" id="cb8-409" data-line-number="409">  intermediates<span class="op">$</span>lambda_delta &lt;-<span class="st"> </span>intermediates<span class="op">$</span>sigma_delta</a>
<a class="sourceLine" id="cb8-410" data-line-number="410">  intermediates</a>
<a class="sourceLine" id="cb8-411" data-line-number="411">}</a>
<a class="sourceLine" id="cb8-412" data-line-number="412"></a>
<a class="sourceLine" id="cb8-413" data-line-number="413"></a>
<a class="sourceLine" id="cb8-414" data-line-number="414"><span class="co"># A</span></a>
<a class="sourceLine" id="cb8-415" data-line-number="415">series_gen &lt;-<span class="st"> </span><span class="cf">function</span>(N, y1, init, sigma1) {</a>
<a class="sourceLine" id="cb8-416" data-line-number="416">  y &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> N)</a>
<a class="sourceLine" id="cb8-417" data-line-number="417">  sigma &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> N)</a>
<a class="sourceLine" id="cb8-418" data-line-number="418">  y[<span class="dv">1</span>] &lt;-<span class="st"> </span>y1</a>
<a class="sourceLine" id="cb8-419" data-line-number="419">  sigma[<span class="dv">1</span>] &lt;-<span class="st"> </span>sigma1</a>
<a class="sourceLine" id="cb8-420" data-line-number="420">  </a>
<a class="sourceLine" id="cb8-421" data-line-number="421">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>N) {</a>
<a class="sourceLine" id="cb8-422" data-line-number="422">    sigma[i] &lt;-<span class="st"> </span>init[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>init[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>y[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>init[<span class="dv">3</span>] <span class="op">*</span><span class="st"> </span>sigma[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb8-423" data-line-number="423">    y[i] &lt;-<span class="st"> </span>sigma[i] <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span><span class="kw">sin</span>(<span class="dv">10</span> <span class="op">*</span><span class="st"> </span>sigma[i]) <span class="op">+</span><span class="st"> </span><span class="kw">sqrt</span>(sigma[i]) <span class="op">*</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-424" data-line-number="424">  }</a>
<a class="sourceLine" id="cb8-425" data-line-number="425">  </a>
<a class="sourceLine" id="cb8-426" data-line-number="426">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb8-427" data-line-number="427">}</a>
<a class="sourceLine" id="cb8-428" data-line-number="428"></a>
<a class="sourceLine" id="cb8-429" data-line-number="429"><span class="co"># B</span></a>
<a class="sourceLine" id="cb8-430" data-line-number="430">series_gen2 &lt;-<span class="st"> </span><span class="cf">function</span>(N, y1, init, sigma1) {</a>
<a class="sourceLine" id="cb8-431" data-line-number="431">  y &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> N)</a>
<a class="sourceLine" id="cb8-432" data-line-number="432">  sigma &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">length =</span> N)</a>
<a class="sourceLine" id="cb8-433" data-line-number="433">  y[<span class="dv">1</span>] &lt;-<span class="st"> </span>y1</a>
<a class="sourceLine" id="cb8-434" data-line-number="434">  sigma[<span class="dv">1</span>] &lt;-<span class="st"> </span>sigma1</a>
<a class="sourceLine" id="cb8-435" data-line-number="435">  </a>
<a class="sourceLine" id="cb8-436" data-line-number="436">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>N) {</a>
<a class="sourceLine" id="cb8-437" data-line-number="437">    sigma[i] &lt;-<span class="st"> </span>init[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>init[<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>y[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>init[<span class="dv">3</span>] <span class="op">*</span><span class="st"> </span>sigma[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb8-438" data-line-number="438">    y[i] &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>sigma[i] <span class="op">+</span><span class="st"> </span><span class="fl">0.1</span> <span class="op">*</span><span class="st"> </span><span class="kw">sin</span>(<span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">20</span> <span class="op">*</span><span class="st"> </span>sigma[i]) <span class="op">+</span><span class="st"> </span><span class="kw">sqrt</span>(sigma[i]) <span class="op">*</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-439" data-line-number="439">  }</a>
<a class="sourceLine" id="cb8-440" data-line-number="440">  </a>
<a class="sourceLine" id="cb8-441" data-line-number="441">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb8-442" data-line-number="442">}</a></code></pre></div>
</div>
<div id="simulation-2" class="section level2">
<h2>Simulation</h2>
<div id="a" class="section level3">
<h3>(500, A)</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># set.seed(1234)</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co"># N &lt;- 500</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co"># init &lt;- c(0.01, 0.1, 0.68)</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># sigma_1 &lt;- 0.1</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co"># </span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># resultA_bf1 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co"># timeA_bf1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co"># iterA_bf1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co"># judge_test &lt;- NULL</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co"># resultA_sp1 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co"># timeA_sp1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co"># iterA_sp1 &lt;- vector(length = N)</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co"># resultA_ip1 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="co"># timeA_ip1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co"># iterA_ip1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="co"># i &lt;- 1</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co"># while (i &lt;= 1000) {</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"><span class="co">#   judge &lt;- TRUE</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19"><span class="co">#   while (judge) {</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="co">#     y &lt;- series_gen(N, 0, init, 0.1)</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="co">#     if (all(!is.na(y))) judge &lt;- FALSE</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="co">#   }</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23"><span class="co">#   bf.fit &lt;- bf(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24"><span class="co">#   spmbp.fit &lt;- spmbp_B(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25"><span class="co">#   ##   ip.fit = IP_GARCH_BB(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26"><span class="co">#   theta0 &lt;- c(0, 0, 0)</span></a>
<a class="sourceLine" id="cb9-27" data-line-number="27"><span class="co">#   lambda0 &lt;- rep(0, N)</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28"><span class="co">#   ip_raw &lt;- try(semislv(theta = init, lambda = lambda0, Phi_fn = Phi_fn, Psi_fn = Psi_fn, method = &quot;implicit&quot;, diy = TRUE, data = y, IP_GARCH_BB = IP_GARCH_BB, theta_delta = theta_delta, lambda_delta = lambda_delta, control = list(max_iter = 1, tol = 1e-5)))</span></a>
<a class="sourceLine" id="cb9-29" data-line-number="29"><span class="co">#   ip.fit &lt;- get_result_from_raw(ip_raw)</span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30"><span class="co">#   if (class(ip_raw) != &quot;try-error&quot; &amp; ip.fit$judge_covergence&amp;bf.fit$judge_covergence &amp; spmbp.fit$judge_covergence) {</span></a>
<a class="sourceLine" id="cb9-31" data-line-number="31"><span class="co">#     resultA_bf1[, i] &lt;- bf.fit$beta</span></a>
<a class="sourceLine" id="cb9-32" data-line-number="32"><span class="co">#     timeA_bf1[i] &lt;- bf.fit$run.time</span></a>
<a class="sourceLine" id="cb9-33" data-line-number="33"><span class="co">#     iterA_bf1[i] &lt;- bf.fit$iter</span></a>
<a class="sourceLine" id="cb9-34" data-line-number="34"><span class="co">#     resultA_sp1[, i] &lt;- spmbp.fit$beta</span></a>
<a class="sourceLine" id="cb9-35" data-line-number="35"><span class="co">#     timeA_sp1[i] &lt;- spmbp.fit$run.time</span></a>
<a class="sourceLine" id="cb9-36" data-line-number="36"><span class="co">#     iterA_sp1[i] &lt;- spmbp.fit$iter</span></a>
<a class="sourceLine" id="cb9-37" data-line-number="37"><span class="co">#     resultA_ip1[, i] &lt;- ip.fit$beta</span></a>
<a class="sourceLine" id="cb9-38" data-line-number="38"><span class="co">#     timeA_ip1[i] &lt;- ip.fit$run.time</span></a>
<a class="sourceLine" id="cb9-39" data-line-number="39"><span class="co">#     iterA_ip1[i] &lt;- ip.fit$iter</span></a>
<a class="sourceLine" id="cb9-40" data-line-number="40"><span class="co">#     i &lt;- i + 1</span></a>
<a class="sourceLine" id="cb9-41" data-line-number="41"><span class="co">#     cat(&quot;Time&quot;, i, &quot;\n&quot;)</span></a>
<a class="sourceLine" id="cb9-42" data-line-number="42"><span class="co">#   }</span></a>
<a class="sourceLine" id="cb9-43" data-line-number="43"><span class="co"># }</span></a>
<a class="sourceLine" id="cb9-44" data-line-number="44"><span class="co"># resultA_bf1 &lt;- resultA_bf1[, which(!is.na(resultA_bf1[1, ]))]</span></a>
<a class="sourceLine" id="cb9-45" data-line-number="45"><span class="co"># resultA_sp1 &lt;- resultA_sp1[, which(!is.na(resultA_sp1[1, ]))]</span></a>
<a class="sourceLine" id="cb9-46" data-line-number="46"><span class="co"># resultA_ip1 &lt;- resultA_ip1[, which(!is.na(resultA_ip1[1, ]))]</span></a>
<a class="sourceLine" id="cb9-47" data-line-number="47"><span class="co"># </span></a>
<a class="sourceLine" id="cb9-48" data-line-number="48"><span class="co"># tb_A_it1 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb9-49" data-line-number="49"><span class="co"># tb_A_it1[1, ] &lt;- apply(resultA_bf1 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb9-50" data-line-number="50"><span class="co"># tb_A_it1[2, ] &lt;- apply(resultA_bf1, 1, sd)</span></a>
<a class="sourceLine" id="cb9-51" data-line-number="51"><span class="co"># tb_A_it1[3, ] &lt;- apply(abs(resultA_bf1 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb9-52" data-line-number="52"><span class="co"># tb_A_it1[4, ] &lt;- sqrt(apply((resultA_bf1 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb9-53" data-line-number="53"><span class="co"># </span></a>
<a class="sourceLine" id="cb9-54" data-line-number="54"><span class="co"># rownames(tb_A_it1) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb9-55" data-line-number="55"><span class="co"># print(tb_A_it1)</span></a>
<a class="sourceLine" id="cb9-56" data-line-number="56"><span class="co"># </span></a>
<a class="sourceLine" id="cb9-57" data-line-number="57"><span class="co"># tb_A_spmbp1 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb9-58" data-line-number="58"><span class="co"># tb_A_spmbp1[1, ] &lt;- apply(resultA_sp1 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb9-59" data-line-number="59"><span class="co"># tb_A_spmbp1[2, ] &lt;- apply(resultA_sp1, 1, sd)</span></a>
<a class="sourceLine" id="cb9-60" data-line-number="60"><span class="co"># tb_A_spmbp1[3, ] &lt;- apply(abs(resultA_sp1 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb9-61" data-line-number="61"><span class="co"># tb_A_spmbp1[4, ] &lt;- sqrt(apply((resultA_sp1 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb9-62" data-line-number="62"><span class="co"># </span></a>
<a class="sourceLine" id="cb9-63" data-line-number="63"><span class="co"># rownames(tb_A_spmbp1) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb9-64" data-line-number="64"><span class="co"># print(tb_A_spmbp1)</span></a>
<a class="sourceLine" id="cb9-65" data-line-number="65"><span class="co"># </span></a>
<a class="sourceLine" id="cb9-66" data-line-number="66"><span class="co"># tb_A_ip1 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb9-67" data-line-number="67"><span class="co"># tb_A_ip1[1, ] &lt;- apply(resultA_ip1 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb9-68" data-line-number="68"><span class="co"># tb_A_ip1[2, ] &lt;- apply(resultA_ip1, 1, sd)</span></a>
<a class="sourceLine" id="cb9-69" data-line-number="69"><span class="co"># tb_A_ip1[3, ] &lt;- apply(abs(resultA_ip1 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb9-70" data-line-number="70"><span class="co"># tb_A_ip1[4, ] &lt;- sqrt(apply((resultA_ip1 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb9-71" data-line-number="71"><span class="co"># </span></a>
<a class="sourceLine" id="cb9-72" data-line-number="72"><span class="co"># rownames(tb_A_ip1) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb9-73" data-line-number="73"><span class="co"># print(tb_A_ip1)</span></a>
<a class="sourceLine" id="cb9-74" data-line-number="74"><span class="co"># </span></a>
<a class="sourceLine" id="cb9-75" data-line-number="75"><span class="co"># print(mean(timeA_bf1))</span></a>
<a class="sourceLine" id="cb9-76" data-line-number="76"><span class="co"># print(mean(timeA_sp1))</span></a>
<a class="sourceLine" id="cb9-77" data-line-number="77"><span class="co"># print(mean(timeA_ip1)) # 按顺序为it, spmbp与ip</span></a>
<a class="sourceLine" id="cb9-78" data-line-number="78"><span class="co"># print(mean(iterA_bf1))</span></a>
<a class="sourceLine" id="cb9-79" data-line-number="79"><span class="co"># print(mean(iterA_sp1))</span></a>
<a class="sourceLine" id="cb9-80" data-line-number="80"><span class="co"># print(mean(iterA_ip1))</span></a></code></pre></div>
</div>
<div id="a-1" class="section level3">
<h3>(1000, A)</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># set.seed(1234)</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># N &lt;- 1000</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co"># init &lt;- c(0.01, 0.1, 0.68)</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co"># sigma_1 &lt;- 0.1</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co"># resultA_bf &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co"># timeA_bf &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co"># iterA_bf &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co"># judge_test &lt;- NULL</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co"># resultA_sp &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co"># timeA_sp &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co"># iterA_sp &lt;- vector(length = N)</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co"># resultA_ip &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co"># timeA_ip &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co"># iterA_ip &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co"># i &lt;- 1</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co"># while (i &lt;= 1000) {</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co">#   judge &lt;- TRUE</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="co">#   while (judge) {</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="co">#     y &lt;- series_gen(N, 0, init, 0.1)</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="co">#     if (all(!is.na(y))) judge &lt;- FALSE</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22"><span class="co">#   }</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23"><span class="co">#   bf.fit &lt;- bf(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24"><span class="co">#   spmbp.fit &lt;- spmbp_B(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb10-25" data-line-number="25"><span class="co">#   ##   ip.fit = IP_GARCH_BB(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="co">#   theta0 &lt;- c(0, 0, 0)</span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27"><span class="co">#   lambda0 &lt;- rep(0, N)</span></a>
<a class="sourceLine" id="cb10-28" data-line-number="28"><span class="co">#   ip_raw &lt;- try(semislv(theta = init, lambda = lambda0, Phi_fn = Phi_fn, Psi_fn = Psi_fn, method = &quot;implicit&quot;, diy = TRUE, data = y, IP_GARCH_BB = IP_GARCH_BB, theta_delta = theta_delta, lambda_delta = lambda_delta, control = list(max_iter = 1, tol = 1e-5)))</span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29"><span class="co">#   ip.fit &lt;- get_result_from_raw(ip_raw)</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30"><span class="co">#   if (class(ip_raw) != &quot;try-error&quot; &amp; ip.fit$judge_covergence&amp;bf.fit$judge_covergence &amp; spmbp.fit$judge_covergence) {</span></a>
<a class="sourceLine" id="cb10-31" data-line-number="31"><span class="co">#     resultA_bf[, i] &lt;- bf.fit$beta</span></a>
<a class="sourceLine" id="cb10-32" data-line-number="32"><span class="co">#     timeA_bf[i] &lt;- bf.fit$run.time</span></a>
<a class="sourceLine" id="cb10-33" data-line-number="33"><span class="co">#     iterA_bf[i] &lt;- bf.fit$iter</span></a>
<a class="sourceLine" id="cb10-34" data-line-number="34"><span class="co">#     resultA_sp[, i] &lt;- spmbp.fit$beta</span></a>
<a class="sourceLine" id="cb10-35" data-line-number="35"><span class="co">#     timeA_sp[i] &lt;- spmbp.fit$run.time</span></a>
<a class="sourceLine" id="cb10-36" data-line-number="36"><span class="co">#     iterA_sp[i] &lt;- spmbp.fit$iter</span></a>
<a class="sourceLine" id="cb10-37" data-line-number="37"><span class="co">#     resultA_ip[, i] &lt;- ip.fit$beta</span></a>
<a class="sourceLine" id="cb10-38" data-line-number="38"><span class="co">#     timeA_ip[i] &lt;- ip.fit$run.time</span></a>
<a class="sourceLine" id="cb10-39" data-line-number="39"><span class="co">#     iterA_ip[i] &lt;- ip.fit$iter</span></a>
<a class="sourceLine" id="cb10-40" data-line-number="40"><span class="co">#     i &lt;- i + 1</span></a>
<a class="sourceLine" id="cb10-41" data-line-number="41"><span class="co">#     cat(&quot;Time&quot;, i, &quot;\n&quot;)</span></a>
<a class="sourceLine" id="cb10-42" data-line-number="42"><span class="co">#   }</span></a>
<a class="sourceLine" id="cb10-43" data-line-number="43"><span class="co"># }</span></a>
<a class="sourceLine" id="cb10-44" data-line-number="44"><span class="co"># resultA_bf &lt;- resultA_bf[, which(!is.na(resultA_bf[1, ]))]</span></a>
<a class="sourceLine" id="cb10-45" data-line-number="45"><span class="co"># resultA_sp &lt;- resultA_sp[, which(!is.na(resultA_sp[1, ]))]</span></a>
<a class="sourceLine" id="cb10-46" data-line-number="46"><span class="co"># resultA_ip &lt;- resultA_ip[, which(!is.na(resultA_ip[1, ]))]</span></a>
<a class="sourceLine" id="cb10-47" data-line-number="47"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-48" data-line-number="48"><span class="co"># tb_A_it &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb10-49" data-line-number="49"><span class="co"># tb_A_it[1, ] &lt;- apply(resultA_bf - init, 1, mean)</span></a>
<a class="sourceLine" id="cb10-50" data-line-number="50"><span class="co"># tb_A_it[2, ] &lt;- apply(resultA_bf, 1, sd)</span></a>
<a class="sourceLine" id="cb10-51" data-line-number="51"><span class="co"># tb_A_it[3, ] &lt;- apply(abs(resultA_bf - init), 1, mean)</span></a>
<a class="sourceLine" id="cb10-52" data-line-number="52"><span class="co"># tb_A_it[4, ] &lt;- sqrt(apply((resultA_bf - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb10-53" data-line-number="53"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-54" data-line-number="54"><span class="co"># rownames(tb_A_it) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb10-55" data-line-number="55"><span class="co"># print(tb_A_it)</span></a>
<a class="sourceLine" id="cb10-56" data-line-number="56"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-57" data-line-number="57"><span class="co"># tb_A_spmbp &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb10-58" data-line-number="58"><span class="co"># tb_A_spmbp[1, ] &lt;- apply(resultA_sp - init, 1, mean)</span></a>
<a class="sourceLine" id="cb10-59" data-line-number="59"><span class="co"># tb_A_spmbp[2, ] &lt;- apply(resultA_sp, 1, sd)</span></a>
<a class="sourceLine" id="cb10-60" data-line-number="60"><span class="co"># tb_A_spmbp[3, ] &lt;- apply(abs(resultA_sp - init), 1, mean)</span></a>
<a class="sourceLine" id="cb10-61" data-line-number="61"><span class="co"># tb_A_spmbp[4, ] &lt;- sqrt(apply((resultA_sp - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb10-62" data-line-number="62"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-63" data-line-number="63"><span class="co"># rownames(tb_A_spmbp) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb10-64" data-line-number="64"><span class="co"># print(tb_A_spmbp)</span></a>
<a class="sourceLine" id="cb10-65" data-line-number="65"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-66" data-line-number="66"><span class="co"># tb_A_ip &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb10-67" data-line-number="67"><span class="co"># tb_A_ip[1, ] &lt;- apply(resultA_ip - init, 1, mean)</span></a>
<a class="sourceLine" id="cb10-68" data-line-number="68"><span class="co"># tb_A_ip[2, ] &lt;- apply(resultA_ip, 1, sd)</span></a>
<a class="sourceLine" id="cb10-69" data-line-number="69"><span class="co"># tb_A_ip[3, ] &lt;- apply(abs(resultA_ip - init), 1, mean)</span></a>
<a class="sourceLine" id="cb10-70" data-line-number="70"><span class="co"># tb_A_ip[4, ] &lt;- sqrt(apply((resultA_ip - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb10-71" data-line-number="71"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-72" data-line-number="72"><span class="co"># rownames(tb_A_ip) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb10-73" data-line-number="73"><span class="co"># print(tb_A_ip)</span></a>
<a class="sourceLine" id="cb10-74" data-line-number="74"><span class="co"># </span></a>
<a class="sourceLine" id="cb10-75" data-line-number="75"><span class="co"># print(mean(timeA_bf))</span></a>
<a class="sourceLine" id="cb10-76" data-line-number="76"><span class="co"># print(mean(timeA_sp))</span></a>
<a class="sourceLine" id="cb10-77" data-line-number="77"><span class="co"># print(mean(timeA_ip)) # 按顺序为it, spmbp与ip</span></a>
<a class="sourceLine" id="cb10-78" data-line-number="78"><span class="co"># print(mean(iterA_bf))</span></a>
<a class="sourceLine" id="cb10-79" data-line-number="79"><span class="co"># print(mean(iterA_sp))</span></a>
<a class="sourceLine" id="cb10-80" data-line-number="80"><span class="co"># print(mean(iterA_ip))</span></a></code></pre></div>
</div>
<div id="b" class="section level3">
<h3>(500, B)</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># set.seed(1234)</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co"># N &lt;- 500</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co"># init &lt;- c(0.01, 0.1, 0.8)</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co"># sigma_1 &lt;- 0.1</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co"># resultB_bf1 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co"># timeB_bf1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co"># iterB_bf1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co"># judge_test &lt;- NULL</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co"># resultB_sp1 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co"># timeB_sp1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co"># iterB_sp1 &lt;- vector(length = N)</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co"># resultB_ip1 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co"># timeB_ip1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co"># iterB_ip1 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co"># i &lt;- 1</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co"># while (i &lt;= 1000) {</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="co">#   judge &lt;- TRUE</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"><span class="co">#   while (judge) {</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">#     y &lt;- series_gen2(N, 0, init, 0.1)</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="co">#     if (all(!is.na(y))) judge &lt;- FALSE</span></a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="co">#   }</span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="co">#   bf.fit &lt;- bf(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="co">#   spmbp.fit &lt;- spmbp_B(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25"><span class="co">#   ##   ip.fit = IP_GARCH_BB(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="co">#   theta0 &lt;- c(0, 0, 0)</span></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="co">#   lambda0 &lt;- rep(0, N)</span></a>
<a class="sourceLine" id="cb11-28" data-line-number="28"><span class="co">#   ip_raw &lt;- try(semislv(theta = init, lambda = lambda0, Phi_fn = Phi_fn, Psi_fn = Psi_fn, method = &quot;implicit&quot;, diy = TRUE, data = y, IP_GARCH_BB = IP_GARCH_BB, theta_delta = theta_delta, lambda_delta = lambda_delta, control = list(max_iter = 1, tol = 1e-5)))</span></a>
<a class="sourceLine" id="cb11-29" data-line-number="29"><span class="co">#   ip.fit &lt;- get_result_from_raw(ip_raw)</span></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="co">#   if (class(ip_raw) != &quot;try-error&quot; &amp; ip.fit$judge_covergence&amp;bf.fit$judge_covergence &amp; spmbp.fit$judge_covergence) {</span></a>
<a class="sourceLine" id="cb11-31" data-line-number="31"><span class="co">#     resultB_bf1[, i] &lt;- bf.fit$beta</span></a>
<a class="sourceLine" id="cb11-32" data-line-number="32"><span class="co">#     timeB_bf1[i] &lt;- bf.fit$run.time</span></a>
<a class="sourceLine" id="cb11-33" data-line-number="33"><span class="co">#     iterB_bf1[i] &lt;- bf.fit$iter</span></a>
<a class="sourceLine" id="cb11-34" data-line-number="34"><span class="co">#     resultB_sp1[, i] &lt;- spmbp.fit$beta</span></a>
<a class="sourceLine" id="cb11-35" data-line-number="35"><span class="co">#     timeB_sp1[i] &lt;- spmbp.fit$run.time</span></a>
<a class="sourceLine" id="cb11-36" data-line-number="36"><span class="co">#     iterB_sp1[i] &lt;- spmbp.fit$iter</span></a>
<a class="sourceLine" id="cb11-37" data-line-number="37"><span class="co">#     resultB_ip1[, i] &lt;- ip.fit$beta</span></a>
<a class="sourceLine" id="cb11-38" data-line-number="38"><span class="co">#     timeB_ip1[i] &lt;- ip.fit$run.time</span></a>
<a class="sourceLine" id="cb11-39" data-line-number="39"><span class="co">#     iterB_ip1[i] &lt;- ip.fit$iter</span></a>
<a class="sourceLine" id="cb11-40" data-line-number="40"><span class="co">#     i &lt;- i + 1</span></a>
<a class="sourceLine" id="cb11-41" data-line-number="41"><span class="co">#     cat(&quot;Time&quot;, i, &quot;\n&quot;)</span></a>
<a class="sourceLine" id="cb11-42" data-line-number="42"><span class="co">#   }</span></a>
<a class="sourceLine" id="cb11-43" data-line-number="43"><span class="co"># }</span></a>
<a class="sourceLine" id="cb11-44" data-line-number="44"><span class="co"># resultB_bf1 &lt;- resultB_bf1[, which(!is.na(resultB_bf1[1, ]))]</span></a>
<a class="sourceLine" id="cb11-45" data-line-number="45"><span class="co"># resultB_sp1 &lt;- resultB_sp1[, which(!is.na(resultB_sp1[1, ]))]</span></a>
<a class="sourceLine" id="cb11-46" data-line-number="46"><span class="co"># resultB_ip1 &lt;- resultB_ip1[, which(!is.na(resultB_ip1[1, ]))]</span></a>
<a class="sourceLine" id="cb11-47" data-line-number="47"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-48" data-line-number="48"><span class="co"># tb_B_it1 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb11-49" data-line-number="49"><span class="co"># tb_B_it1[1, ] &lt;- apply(resultB_bf1 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb11-50" data-line-number="50"><span class="co"># tb_B_it1[2, ] &lt;- apply(resultB_bf1, 1, sd)</span></a>
<a class="sourceLine" id="cb11-51" data-line-number="51"><span class="co"># tb_B_it1[3, ] &lt;- apply(abs(resultB_bf1 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb11-52" data-line-number="52"><span class="co"># tb_B_it1[4, ] &lt;- sqrt(apply((resultB_bf1 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb11-53" data-line-number="53"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-54" data-line-number="54"><span class="co"># rownames(tb_B_it1) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb11-55" data-line-number="55"><span class="co"># print(tb_B_it1)</span></a>
<a class="sourceLine" id="cb11-56" data-line-number="56"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-57" data-line-number="57"><span class="co"># tb_B_spmbp1 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb11-58" data-line-number="58"><span class="co"># tb_B_spmbp1[1, ] &lt;- apply(resultB_sp1 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb11-59" data-line-number="59"><span class="co"># tb_B_spmbp1[2, ] &lt;- apply(resultB_sp1, 1, sd)</span></a>
<a class="sourceLine" id="cb11-60" data-line-number="60"><span class="co"># tb_B_spmbp1[3, ] &lt;- apply(abs(resultB_sp1 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb11-61" data-line-number="61"><span class="co"># tb_B_spmbp1[4, ] &lt;- sqrt(apply((resultB_sp1 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb11-62" data-line-number="62"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-63" data-line-number="63"><span class="co"># rownames(tb_B_spmbp1) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb11-64" data-line-number="64"><span class="co"># print(tb_B_spmbp1)</span></a>
<a class="sourceLine" id="cb11-65" data-line-number="65"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-66" data-line-number="66"><span class="co"># tb_B_ip1 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb11-67" data-line-number="67"><span class="co"># tb_B_ip1[1, ] &lt;- apply(resultB_ip1 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb11-68" data-line-number="68"><span class="co"># tb_B_ip1[2, ] &lt;- apply(resultB_ip1, 1, sd)</span></a>
<a class="sourceLine" id="cb11-69" data-line-number="69"><span class="co"># tb_B_ip1[3, ] &lt;- apply(abs(resultB_ip1 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb11-70" data-line-number="70"><span class="co"># tb_B_ip1[4, ] &lt;- sqrt(apply((resultB_ip1 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb11-71" data-line-number="71"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-72" data-line-number="72"><span class="co"># rownames(tb_B_ip1) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb11-73" data-line-number="73"><span class="co"># print(tb_B_ip1)</span></a>
<a class="sourceLine" id="cb11-74" data-line-number="74"><span class="co"># </span></a>
<a class="sourceLine" id="cb11-75" data-line-number="75"><span class="co"># print(mean(timeB_bf1))</span></a>
<a class="sourceLine" id="cb11-76" data-line-number="76"><span class="co"># print(mean(timeB_sp1))</span></a>
<a class="sourceLine" id="cb11-77" data-line-number="77"><span class="co"># print(mean(timeB_ip1)) </span></a>
<a class="sourceLine" id="cb11-78" data-line-number="78"><span class="co"># print(mean(iterB_bf1))</span></a>
<a class="sourceLine" id="cb11-79" data-line-number="79"><span class="co"># print(mean(iterB_sp1))</span></a>
<a class="sourceLine" id="cb11-80" data-line-number="80"><span class="co"># print(mean(iterB_ip1))</span></a></code></pre></div>
</div>
<div id="b-1" class="section level3">
<h3>(1000, B)</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># set.seed(1234)</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co"># N &lt;- 1000</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co"># init &lt;- c(0.01, 0.1, 0.8)</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co"># sigma_1 &lt;- 0.1</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co"># resultB_bf2 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co"># timeB_bf2 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co"># iterB_bf2 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co"># judge_test &lt;- NULL</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co"># resultB_sp2 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co"># timeB_sp2 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co"># iterB_sp2 &lt;- vector(length = N)</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co"># resultB_ip2 &lt;- matrix(nrow = 3, ncol = 1000)</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co"># timeB_ip2 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co"># iterB_ip2 &lt;- vector(length = 1000)</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co"># i &lt;- 1</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co"># while (i &lt;= 1000) {</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#   judge &lt;- TRUE</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="co">#   while (judge) {</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">#     y &lt;- series_gen2(N, 0, init, 0.1)</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="co">#     if (all(!is.na(y))) judge &lt;- FALSE</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="co">#   }</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="co">#   bf.fit &lt;- bf(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="co">#   spmbp.fit &lt;- spmbp_B(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="co">#   ##   ip.fit = IP_GARCH_BB(y, init = init, sigma_1 = 0.1, judge_k = T)</span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27"><span class="co">#   theta0 &lt;- c(0, 0, 0)</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="co">#   lambda0 &lt;- rep(0, N)</span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="co">#   ip_raw &lt;- try(semislv(theta = init, lambda = lambda0, Phi_fn = Phi_fn, Psi_fn = Psi_fn, method = &quot;implicit&quot;, diy = TRUE, data = y, IP_GARCH_BB = IP_GARCH_BB, theta_delta = theta_delta, lambda_delta = lambda_delta, control = list(max_iter = 1, tol = 1e-5)))</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="co">#   ip.fit &lt;- get_result_from_raw(ip_raw)</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="co">#   if (class(ip_raw) != &quot;try-error&quot; &amp; ip.fit$judge_covergence&amp;bf.fit$judge_covergence &amp; spmbp.fit$judge_covergence) {</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32"><span class="co">#     resultB_bf2[, i] &lt;- bf.fit$beta</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="co">#     timeB_bf2[i] &lt;- bf.fit$run.time</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="co">#     iterB_bf2[i] &lt;- bf.fit$iter</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="co">#     resultB_sp2[, i] &lt;- spmbp.fit$beta</span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36"><span class="co">#     timeB_sp2[i] &lt;- spmbp.fit$run.time</span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37"><span class="co">#     iterB_sp2[i] &lt;- spmbp.fit$iter</span></a>
<a class="sourceLine" id="cb12-38" data-line-number="38"><span class="co">#     resultB_ip2[, i] &lt;- ip.fit$beta</span></a>
<a class="sourceLine" id="cb12-39" data-line-number="39"><span class="co">#     timeB_ip2[i] &lt;- ip.fit$run.time</span></a>
<a class="sourceLine" id="cb12-40" data-line-number="40"><span class="co">#     iterB_ip2[i] &lt;- ip.fit$iter</span></a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="co">#     i &lt;- i + 1</span></a>
<a class="sourceLine" id="cb12-42" data-line-number="42"><span class="co">#     cat(&quot;Time&quot;, i, &quot;\n&quot;)</span></a>
<a class="sourceLine" id="cb12-43" data-line-number="43"><span class="co">#   }</span></a>
<a class="sourceLine" id="cb12-44" data-line-number="44"><span class="co"># }</span></a>
<a class="sourceLine" id="cb12-45" data-line-number="45"><span class="co"># resultB_bf2 &lt;- resultB_bf2[, which(!is.na(resultB_bf2[1, ]))]</span></a>
<a class="sourceLine" id="cb12-46" data-line-number="46"><span class="co"># resultB_sp2 &lt;- resultB_sp2[, which(!is.na(resultB_sp2[1, ]))]</span></a>
<a class="sourceLine" id="cb12-47" data-line-number="47"><span class="co"># resultB_ip2 &lt;- resultB_ip2[, which(!is.na(resultB_ip2[1, ]))]</span></a>
<a class="sourceLine" id="cb12-48" data-line-number="48"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-49" data-line-number="49"><span class="co"># tb_B_it2 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb12-50" data-line-number="50"><span class="co"># tb_B_it2[1, ] &lt;- apply(resultB_bf2 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb12-51" data-line-number="51"><span class="co"># tb_B_it2[2, ] &lt;- apply(resultB_bf2, 1, sd)</span></a>
<a class="sourceLine" id="cb12-52" data-line-number="52"><span class="co"># tb_B_it2[3, ] &lt;- apply(abs(resultB_bf2 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb12-53" data-line-number="53"><span class="co"># tb_B_it2[4, ] &lt;- sqrt(apply((resultB_bf2 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb12-54" data-line-number="54"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-55" data-line-number="55"><span class="co"># rownames(tb_B_it2) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb12-56" data-line-number="56"><span class="co"># print(tb_B_it2)</span></a>
<a class="sourceLine" id="cb12-57" data-line-number="57"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-58" data-line-number="58"><span class="co"># tb_B_spmbp2 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb12-59" data-line-number="59"><span class="co"># tb_B_spmbp2[1, ] &lt;- apply(resultB_sp2 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb12-60" data-line-number="60"><span class="co"># tb_B_spmbp2[2, ] &lt;- apply(resultB_sp2, 1, sd)</span></a>
<a class="sourceLine" id="cb12-61" data-line-number="61"><span class="co"># tb_B_spmbp2[3, ] &lt;- apply(abs(resultB_sp2 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb12-62" data-line-number="62"><span class="co"># tb_B_spmbp2[4, ] &lt;- sqrt(apply((resultB_sp2 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb12-63" data-line-number="63"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-64" data-line-number="64"><span class="co"># rownames(tb_B_spmbp2) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb12-65" data-line-number="65"><span class="co"># print(tb_B_spmbp2)</span></a>
<a class="sourceLine" id="cb12-66" data-line-number="66"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-67" data-line-number="67"><span class="co"># tb_B_ip2 &lt;- matrix(nrow = 4, ncol = 3)</span></a>
<a class="sourceLine" id="cb12-68" data-line-number="68"><span class="co"># tb_B_ip2[1, ] &lt;- apply(resultB_ip2 - init, 1, mean)</span></a>
<a class="sourceLine" id="cb12-69" data-line-number="69"><span class="co"># tb_B_ip2[2, ] &lt;- apply(resultB_ip2, 1, sd)</span></a>
<a class="sourceLine" id="cb12-70" data-line-number="70"><span class="co"># tb_B_ip2[3, ] &lt;- apply(abs(resultB_ip2 - init), 1, mean)</span></a>
<a class="sourceLine" id="cb12-71" data-line-number="71"><span class="co"># tb_B_ip2[4, ] &lt;- sqrt(apply((resultB_ip2 - init)^2, 1, mean))</span></a>
<a class="sourceLine" id="cb12-72" data-line-number="72"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-73" data-line-number="73"><span class="co"># rownames(tb_B_ip2) &lt;- c(&quot;BIAS&quot;, &quot;SD&quot;, &quot;MAE&quot;, &quot;RMSE&quot;)</span></a>
<a class="sourceLine" id="cb12-74" data-line-number="74"><span class="co"># print(tb_B_ip2)</span></a>
<a class="sourceLine" id="cb12-75" data-line-number="75"><span class="co"># </span></a>
<a class="sourceLine" id="cb12-76" data-line-number="76"><span class="co"># print(mean(timeB_bf2))</span></a>
<a class="sourceLine" id="cb12-77" data-line-number="77"><span class="co"># print(mean(timeB_sp2))</span></a>
<a class="sourceLine" id="cb12-78" data-line-number="78"><span class="co"># print(mean(timeB_ip2)) # 按顺序为it, spmbp与ip</span></a>
<a class="sourceLine" id="cb12-79" data-line-number="79"><span class="co"># print(mean(iterB_bf2))</span></a>
<a class="sourceLine" id="cb12-80" data-line-number="80"><span class="co"># print(mean(iterB_sp2))</span></a>
<a class="sourceLine" id="cb12-81" data-line-number="81"><span class="co"># print(mean(iterB_ip2))</span></a></code></pre></div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
